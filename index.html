<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DepoE: EO'nun D√ºkkanƒ±</title>
    <style>
        :root {
            --bg-color: #0f0c29;
            --bg-gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --text-color: #ffffff;
            --accent-color: #ffd700; /* Gold */
            --danger-color: #ff4b4b;
            --success-color: #00e676;
            --eo-color: #d500f9;
            --black-market-color: #9d00ff;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            background-size: cover;
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* UTILS - GLASSMORPHISM */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

        .hidden { display: none !important; }

        .btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            padding: 12px 24px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            margin: 5px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            backdrop-filter: blur(4px);
        }
        .btn:hover {
            background: var(--accent-color);
            color: #000;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }
        .btn-danger:hover {
             background: var(--danger-color);
             box-shadow: 0 5px 15px rgba(255, 75, 75, 0.4);
        }
        .btn-purple:hover {
            background: var(--eo-color);
            color: white;
            box-shadow: 0 5px 15px rgba(213, 0, 249, 0.4);
        }

        .btn:disabled {
            border-color: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.3);
            cursor: not-allowed;
            background: rgba(0,0,0,0.2);
            transform: none;
            box-shadow: none;
        }

        /* HEADER */
        header {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(15px);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--glass-border);
            z-index: 100;
        }
        .stats {
            display: flex;
            gap: 25px;
        }
        .stat-box {
            text-align: right;
        }
        .stat-label {
            color: rgba(255,255,255,0.6);
            font-size: 0.75rem;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .money { color: var(--success-color); font-weight: bold; }

        .logo {
            font-weight: 900;
            font-size: 1.8rem;
            background: linear-gradient(to right, #ffd700, #ff8c00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        /* MAIN CONTENT AREA */
        main {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Changed from center to allow scrolling if needed */
        }

        /* SCREENS */
        .screen {
            width: 100%;
            max-width: 900px;
            text-align: center;
            animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1);
            padding: 30px;
            margin-top: 20px;
        }

        /* Glass Panel Container for Screens */
        .screen-glass {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: var(--shadow);
            padding: 40px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); scale: 0.95; }
            to { opacity: 1; transform: translateY(0); scale: 1; }
        }

        /* STORAGE SELECTION */
        .storage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        .storage-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            padding: 20px;
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 200px;
            position: relative;
            overflow: hidden;
        }
        .storage-card:hover {
            transform: translateY(-10px);
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-color);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        }
        .storage-card h3 { margin-top: 0; color: var(--accent-color); }

        .storage-card.black-market {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            border-color: #ff0000;
            box-shadow: 0 0 20px rgba(139, 0, 0, 0.3);
            animation: pulse-red 2s infinite;
            font-weight: 800;
        }
        .storage-card.black-market h3 { color: #ff0000; }
        .storage-card.black-market p, .storage-card.black-market div { color: #f0f0f0; }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 20px rgba(139, 0, 0, 0.3); }
            50% { box-shadow: 0 0 35px rgba(255, 0, 0, 0.6); }
            100% { box-shadow: 0 0 20px rgba(139, 0, 0, 0.3); }
        }

        .risk-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-top: 10px;
        }
        .risk-low { background: rgba(0, 230, 118, 0.2); color: #00e676; }
        .risk-med { background: rgba(255, 215, 0, 0.2); color: #ffd700; }
        .risk-high { background: rgba(255, 75, 75, 0.2); color: #ff4b4b; }
        .risk-black { background: #000; color: #ff0000; border: 1px solid #ff0000; }

        /* ITEM REVEAL & LISTS */
        .item-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 30px 0;
            text-align: left;
        }
        .item-row {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px 20px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid transparent;
            transition: all 0.2s;
        }
        .item-row:hover { background: rgba(255,255,255,0.05); }

        .rarity-junk { border-color: #9e9e9e; }
        .rarity-common { border-color: var(--success-color); }
        .rarity-rare { border-color: var(--accent-color); }
        .rarity-legendary { border-color: #ffeb3b; background: linear-gradient(90deg, rgba(255, 235, 59, 0.1), transparent); }

        .certified-badge {
            background: var(--accent-color);
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 8px;
            vertical-align: middle;
        }

        /* NEGOTIATION SCENE */
        .scene-container {
            display: flex;
            flex-direction: column;
            height: 500px;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            background: url('https://images.unsplash.com/photo-1550523092-234293e50669?q=80&w=2070&auto=format&fit=crop') center/cover no-repeat;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.8);
            border: 1px solid var(--glass-border);
        }

        /* Dark overlay for the background image */
        .scene-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 12, 41, 0.7);
            z-index: 1;
        }

        .eo-avatar-container {
            z-index: 2;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
        }

        .eo-avatar {
            font-size: 80px;
            background: radial-gradient(circle, rgba(156, 39, 176, 0.5) 0%, rgba(0,0,0,0) 70%);
            padding: 20px;
            border-radius: 50%;
            animation: float 3s ease-in-out infinite;
            text-shadow: 0 0 30px var(--eo-color);
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .speech-bubble {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 15px 25px;
            border-radius: 20px;
            border-bottom-left-radius: 0;
            max-width: 60%;
            margin-top: 10px;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            position: relative;
            z-index: 3;
            text-align: left;
        }
        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            border-width: 10px 10px 0;
            border-style: solid;
            border-color: rgba(255, 255, 255, 0.95) transparent;
        }

        .negotiation-desk {
            z-index: 2;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            padding: 20px;
            border-top: 1px solid var(--glass-border);
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .desk-item {
            flex: 1;
            text-align: left;
        }

        .desk-actions {
            flex: 2;
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-end;
            gap: 10px;
        }

        /* HUB MENU */
        .hub-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }

        .hub-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 30px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .hub-card:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-5px);
            border-color: var(--accent-color);
        }
        .hub-icon { font-size: 3rem; }
        .hub-title { font-size: 1.2rem; font-weight: bold; }

        /* ANIMATIONS */
        .float-up {
            position: absolute;
            animation: floatUp 1s ease-out forwards;
            font-weight: bold;
            font-size: 1.5rem;
            pointer-events: none;
            z-index: 1000;
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-50px); }
        }

        .stamp-anim {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg) scale(2);
            font-size: 5rem;
            color: var(--danger-color);
            border: 5px solid var(--danger-color);
            padding: 10px 40px;
            font-weight: 900;
            opacity: 0;
            animation: stampIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            pointer-events: none;
            z-index: 2000;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        @keyframes stampIn {
            0% { opacity: 0; transform: translate(-50%, -50%) rotate(-15deg) scale(3); }
            100% { opacity: 1; transform: translate(-50%, -50%) rotate(-15deg) scale(1); }
        }

        .shake {
            animation: shake 0.5s;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }

    </style>
</head>
<body>

    <header>
        <div class="logo">DepoE üì¶</div>
        <div class="stats">
            <div class="stat-box">
                <span class="stat-label">üóìÔ∏è TUR</span><br>
                <span id="ui-round">1</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">üí∞ BAKƒ∞YE</span><br>
                <span id="ui-money" class="money">1000 ‚Ç∫</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">ü§ù ƒ∞Tƒ∞BAR</span><br>
                <span id="ui-reputation">N√∂tr</span>
            </div>
        </div>
    </header>

    <main id="app">
        <!-- Screens will be injected here by JS -->
        <div id="loading" class="screen">
            <h2>Y√ºkleniyor...</h2>
        </div>
    </main>

    <script>
        // --- CONFIG & CONSTANTS ---
        const GAME_CONFIG = {
            startMoney: 2000, // Enough for a low tier unit
            maxRounds: 999, // Infinite for now
        };

        const RARITY = {
            JUNK: { id: 'junk', label: 'Hurda', color: '#9e9e9e', mult: 0.5 },
            COMMON: { id: 'common', label: 'Sƒ±radan', color: '#4caf50', mult: 1.0 },
            RARE: { id: 'rare', label: 'Nadir', color: '#ff9800', mult: 2.5 },
            LEGENDARY: { id: 'legendary', label: 'Efsanevi', color: '#ffeb3b', mult: 10.0 }
        };

        const ITEMS_DB = [
            // JUNK
            { name: "Eski Gazete Yƒ±ƒüƒ±nƒ±", type: "junk", baseValue: 20 },
            { name: "Kƒ±rƒ±k Sandalye", type: "junk", baseValue: 50 },
            { name: "Paslƒ± Bisiklet Tekerleƒüi", type: "junk", baseValue: 30 },
            { name: "K√ºfl√º Kitaplar", type: "junk", baseValue: 40 },
            { name: "Tek Ayakkabƒ±", type: "junk", baseValue: 10 },
            { name: "Bozuk Vantilat√∂r", type: "junk", baseValue: 80 },
            { name: "Tek Teylik (Sol)", type: "junk", baseValue: 5 },
            { name: "Bo≈ü Yoƒüurt Kaplarƒ±", type: "junk", baseValue: 10 },
            { name: "D√ºƒü√ºm√º √á√∂z√ºlemeyen Kablo Yumaƒüƒ±", type: "junk", baseValue: 25 },
            { name: "Kƒ±rƒ±k ≈ûemsiye", type: "junk", baseValue: 15 },
            { name: "Tarihi Ge√ßmi≈ü Konserveler", type: "junk", baseValue: 30 },
            { name: "Patlak Futbol Topu", type: "junk", baseValue: 20 },
            { name: "√áatlak Plastik Kova", type: "junk", baseValue: 10 },
            { name: "Eski Takvim Yapraklarƒ±", type: "junk", baseValue: 5 },
            { name: "Kƒ±rƒ±k CD √áalar", type: "junk", baseValue: 35 },
            { name: "D√ºƒümesi Kopuk G√∂mlek", type: "junk", baseValue: 15 },
            { name: "Bo≈ü Parf√ºm ≈ûi≈üesi", type: "junk", baseValue: 25 },
            { name: "Tek √áorap", type: "junk", baseValue: 1 },
            { name: "Paslƒ± Anahtar Yƒ±ƒüƒ±nƒ±", type: "junk", baseValue: 12 },
            { name: "Eski Di≈ü Fƒ±r√ßasƒ± (Kullanƒ±lmƒ±≈ü)", type: "junk", baseValue: 2 },
            { name: "Kire√ßli √áaydanlƒ±k Altƒ±", type: "junk", baseValue: 18 },
            { name: "Bozuk Kulaklƒ±k", type: "junk", baseValue: 22 },

            // COMMON
            { name: "ƒ∞kinci El Mikrodalga", type: "common", baseValue: 400 },
            { name: "Ah≈üap Sehpa", type: "common", baseValue: 300 },
            { name: "Kullanƒ±lmƒ±≈ü Ders Kitaplarƒ±", type: "common", baseValue: 250 },
            { name: "Porselen Yemek Takƒ±mƒ± (Eksik)", type: "common", baseValue: 600 },
            { name: "√áalƒ±≈üan Tost Makinesi", type: "common", baseValue: 350 },
            { name: "Balƒ±k Oltasƒ±", type: "common", baseValue: 500 },
            { name: "Eski Model √út√º", type: "common", baseValue: 200 },
            { name: "T√ºpl√º Televizyon", type: "common", baseValue: 300 },
            { name: "Elektrikli Battaniye", type: "common", baseValue: 450 },
            { name: "Dantelli Sehpa √ñrt√ºs√º", type: "common", baseValue: 150 },
            { name: "Mangal Takƒ±mƒ± (Az Kullanƒ±lmƒ±≈ü)", type: "common", baseValue: 550 },
            { name: "Eski Ansiklopedi Seti", type: "common", baseValue: 200 },
            { name: "Diki≈ü Makinesi", type: "common", baseValue: 700 },
            { name: "Plastik Bah√ße Sandalyesi", type: "common", baseValue: 120 },
            { name: "Saz (Baƒülama)", type: "common", baseValue: 800 },
            { name: "Bavul Dolusu Kƒ±yafet", type: "common", baseValue: 400 },
            { name: "Bakƒ±r Cezve", type: "common", baseValue: 250 },
            { name: "√áinko √áaydanlƒ±k", type: "common", baseValue: 180 },
            { name: "Nokia 3310 (√áalƒ±≈üƒ±yor)", type: "common", baseValue: 900 },
            { name: "Deri C√ºzdan (Bo≈ü)", type: "common", baseValue: 150 },
            { name: "Casio Kol Saati", type: "common", baseValue: 600 },
            { name: "Takƒ±m √áantasƒ± (Dolu)", type: "common", baseValue: 750 },
            { name: "Kamp Sandalyesi", type: "common", baseValue: 300 },
            { name: "Dede Yadigarƒ± Tesbih (Plastik)", type: "common", baseValue: 100 },
            { name: "Eski Kaset√ßalar", type: "common", baseValue: 500 },
            { name: "G√ºne≈ü G√∂zl√ºƒü√º (Markasƒ±z)", type: "common", baseValue: 120 },

            // RARE
            { name: "G√ºm√º≈ü √áatal Bƒ±√ßak Seti", type: "rare", baseValue: 5000 },
            { name: "1990 Yapƒ±mƒ± Oyun Konsolu", type: "rare", baseValue: 6500 },
            { name: "ƒ∞mzalƒ± Futbol Formasƒ±", type: "rare", baseValue: 8000 },
            { name: "Antika Cep Saati", type: "rare", baseValue: 9500 },
            { name: "Profesyonel Kamera Lensi", type: "rare", baseValue: 7000 },
            { name: "El Dokumasƒ± Kilim", type: "rare", baseValue: 6000 },
            { name: "ƒ∞lk Basƒ±m √áizgi Roman", type: "rare", baseValue: 5500 },
            { name: "Mekanik Daktilo", type: "rare", baseValue: 7500 },
            { name: "Bakƒ±r ƒ∞mbik", type: "rare", baseValue: 6000 },
            { name: "Koleksiyonluk Plak (Barƒ±≈ü Man√ßo)", type: "rare", baseValue: 9000 },
            { name: "Profesyonel Teleskop", type: "rare", baseValue: 8500 },
            { name: "Eski Marka √áakmak (G√ºm√º≈ü)", type: "rare", baseValue: 5200 },
            { name: "Deri Kovboy √áizmeleri", type: "rare", baseValue: 4500 },
            { name: "Oyuncu Bilgisayarƒ± Kasasƒ±", type: "rare", baseValue: 9800 },
            { name: "Osmanlƒ± Tapusu", type: "rare", baseValue: 8500 },
            { name: "G√ºm√º≈ü ≈ûamdan", type: "rare", baseValue: 7200 },
            { name: "El Dokumasƒ± Isparta Halƒ±sƒ±", type: "rare", baseValue: 9500 },
            { name: "Antika Gramofon", type: "rare", baseValue: 8800 },
            { name: "ƒ∞mzalƒ± Fenerbah√ße Formasƒ± (2008)", type: "rare", baseValue: 7000 },
            { name: "Eski Askeri D√ºrb√ºn", type: "rare", baseValue: 6200 },
            { name: "Kristal Vazo", type: "rare", baseValue: 5800 },
            { name: "Mekanik K√∂stekli Saat", type: "rare", baseValue: 9000 },
            { name: "B√ºy√ºk Boy Yaƒülƒ± Boya Tablo", type: "rare", baseValue: 7500 },

            // LEGENDARY
            { name: "Osmanlƒ± D√∂nemi Han√ßer", type: "legendary", baseValue: 35000 },
            { name: "Altƒ±n Kolye (18 Ayar)", type: "legendary", baseValue: 28000 },
            { name: "Kapalƒ± Kutu Son Model Laptop", type: "legendary", baseValue: 45000 },
            { name: "√únl√º Bir Ressamƒ±n Eskizi", type: "legendary", baseValue: 60000 },
            { name: "Elmas Y√ºz√ºk", type: "legendary", baseValue: 80000 },
            { name: "Meteor Par√ßasƒ±", type: "legendary", baseValue: 40000 },
            { name: "ƒ∞mzalƒ± Atat√ºrk Portresi (Orijinal)", type: "legendary", baseValue: 95000 },
            { name: "Kapalƒ± Kutu Retro Konsol (1985)", type: "legendary", baseValue: 55000 },
            { name: "Viking D√∂nemi Balta Ucu", type: "legendary", baseValue: 70000 },
            { name: "Kripto C√ºzdan (≈ûifresi √úst√ºnde)", type: "legendary", baseValue: 120000 },
            { name: "Safir Ta≈ülƒ± Bro≈ü", type: "legendary", baseValue: 65000 },
            { name: "Fatih Sultan Mehmet'in Fermanƒ± (Par√ßasƒ±)", type: "legendary", baseValue: 150000 },
            { name: "Saf Altƒ±n Tesbih", type: "legendary", baseValue: 95000 },
            { name: "Antik Roma Sikkesi (Altƒ±n)", type: "legendary", baseValue: 110000 },
            { name: "Picasso Eskizi (≈û√ºpheli)", type: "legendary", baseValue: 130000 },
            { name: "Kurtulu≈ü Sava≈üƒ± Madalyasƒ±", type: "legendary", baseValue: 85000 },
            { name: "Meteor Ta≈üƒ± (B√ºy√ºk)", type: "legendary", baseValue: 75000 }
        ];

        // --- EO INTELLIGENCE ---
        const EO_AI = {
            mood: 'neutral', // neutral, happy, annoyed, angry
            patience: 3, // Lowers with bad offers

            dialogue: {
                greeting: {
                    friendly: [
                        "Ooo, benim favori t√ºccarƒ±m gelmi≈ü! Yine mi beni batƒ±rmaya √ßalƒ±≈üacaksƒ±n, yoksa bu sefer ger√ßekten i≈üe yarar bir ≈üeyin var mƒ±?",
                        "Ho≈ü geldin dostum! Bakalƒ±m bug√ºn hangi '≈üahane' mallarƒ± itelemeye √ßalƒ±≈üacaksƒ±n?",
                        "G√∂z√ºm yollarda kaldƒ±. Hadi g√∂ster bakalƒ±m, bug√ºn beni nasƒ±l kandƒ±racaksƒ±n?",
                        "Sen gelince d√ºkkana g√ºne≈ü doƒüuyor resmen. Ama c√ºzdanƒ±m titremeye ba≈üladƒ± bile.",
                        "Kahveni nasƒ±l alƒ±rsƒ±n? ≈ûaka ≈üaka, √∂nce malƒ± g√∂relim."
                    ],
                    neutral: [
                        "Ho≈ü geldin. Bakalƒ±m bug√ºn ne getirdin.",
                        "Umarƒ±m vakit harcamaya deƒüecek ≈üeyler vardƒ±r.",
                        "D√ºkkan a√ßƒ±k, ama sabrƒ±m sƒ±nƒ±rlƒ±. G√∂ster bakalƒ±m.",
                        "G√∂zlerim yollarda kaldƒ±, cebim yanƒ±yor. Hadi ≈üa≈üƒ±rt beni.",
                        "Piyasa durgun, umarƒ±m sen deƒüilsindir."
                    ],
                    suspicious: [
                        "Yine mi sen? √áabuk ol, fazla vaktim yok.",
                        "Sadece bakƒ±yorum, s√∂z vermem. ≈û√ºpheli bir ≈üey g√∂r√ºrsem polisi ararƒ±m.",
                        "Kapƒ±dan girmeden √∂nce ayakkabƒ±larƒ±nƒ± sildin mi? Ne istiyorsun?",
                        "G√∂z√ºm √ºzerinde. Yanlƒ±≈ü bir hareket yapma.",
                        "√áalƒ±ntƒ± mal getirdiysen hemen d√∂n, ba≈üƒ±mƒ± belaya sokma."
                    ]
                },
                inspecting: {
                    friendly: [
                        "Bakalƒ±m bug√ºn hangi hazineyi buldun?",
                        "Bunu benim i√ßin mi sakladƒ±n? Hadi g√∂relim.",
                        "G√ºzel bir ≈üeye benziyor, anlat bakalƒ±m."
                    ],
                    neutral: [
                        "Hƒ±mm... ≈ûuna bir bakalƒ±m.",
                        "Bunun ne olduƒüunu bildiƒüine emin misin?",
                        "ƒ∞lgin√ß... ama satƒ±lƒ±r mƒ± emin deƒüilim."
                    ],
                    suspicious: [
                        "Ceplerini bo≈üalt. Bu ne?",
                        "√áalƒ±ntƒ± mal almƒ±yorum, ba≈ütan s√∂yleyeyim.",
                        "Hƒ±zlƒ± ol, buna deƒüer mi?",
                        "Bunu √ß√∂pten mi buldun? D√ºr√ºst ol."
                    ]
                },
                lowball: {
                    friendly: [
                        "Yapma ≈üimdi, dostuz diye kazƒ±klayacak mƒ±sƒ±n beni?",
                        "Seni severim ama c√ºzdanƒ±mƒ± daha √ßok severim. Fiyat bu.",
                        "Hadi ama, bu fiyata bana ver, hatƒ±rƒ±m kalƒ±r."
                    ],
                    neutral: [
                        "Buna en fazla bu kadar veririm. ƒ∞≈üine gelirse.",
                        "Bak, bu piyasada bundan fazlasƒ±nƒ± bulamazsƒ±n.",
                        "Piyasa durgun, teklifim bu.",
                        "Bu fiyata sakƒ±z bile alamazsƒ±n, kendine gel."
                    ],
                    suspicious: [
                        "Bu hurdaya bu fiyat √ßok bile. Al ya da git.",
                        "Bunu ba≈ükasƒ±na satamazsƒ±n, dua et ben alƒ±yorum.",
                        "Sana bir iyilik yapƒ±p bu parayƒ± veriyorum, uzatma."
                    ]
                },
                accept: {
                    friendly: [
                        "Hah ≈ü√∂yle! Seninle i≈ü yapmayƒ± bu y√ºzden seviyorum.",
                        "G√ºzel anla≈üma. Bir kahve de ƒ±smarlayayƒ±m mƒ±? ≈ûaka ≈üaka, git hadi.",
                        "Tamamdƒ±r dostum, hayrƒ±nƒ± g√∂r."
                    ],
                    neutral: [
                        "Tamamdƒ±r, anla≈ütƒ±k.",
                        "Makul. Al paranƒ±.",
                        "G√ºzel, ver bakalƒ±m."
                    ],
                    suspicious: [
                        "Al paranƒ± ve kaybol.",
                        "Sonunda. Bir daha b√∂yle pazarlƒ±k yapma.",
                        "Tamam, ≈üimdi git d√ºkkanƒ±mdan."
                    ]
                },
                reject: {
                    friendly: [
                        "≈ûakacƒ± seni! Ama cidden, olmaz.",
                        "Beni g√ºld√ºrd√ºn, ama o fiyata imkansƒ±z dostum.",
                        "Yok artƒ±k, o fiyata d√ºkkanƒ± da vereyim mi?"
                    ],
                    neutral: [
                        "Dalga mƒ± ge√ßiyorsun? Git i≈üine.",
                        "Bu fiyatla ancak kendini kandƒ±rƒ±rsƒ±n.",
                        "Benimle oyun oynama evlat."
                    ],
                    suspicious: [
                        "√áƒ±k dƒ±≈üarƒ±! Hemen!",
                        "Seni ciddiye alanda kabahat. Defol.",
                        "Sabrƒ±mƒ± zorluyorsun yabancƒ±.",
                        "Bunu getirmek i√ßin taksi parasƒ± verdiysen yazƒ±k olmu≈ü."
                    ]
                },
                threatResponse: [
                    "Beni tehdit etme, zararlƒ± √ßƒ±karsƒ±n.",
                    "Cesaretini takdir ettim ama aptallƒ±ƒüƒ±nƒ± deƒüil.",
                    "Tamam tamam, sakin ol. Belki bir ≈üeyler yapabiliriz."
                ]
            },

            getLine: function(category, reputation) {
                // If the category is threatResponse (array), return directly
                if (Array.isArray(this.dialogue[category])) {
                    const lines = this.dialogue[category];
                    return lines[Math.floor(Math.random() * lines.length)];
                }

                let tier = 'neutral';
                if (reputation > 70) tier = 'friendly';
                else if (reputation < 30) tier = 'suspicious';

                const lines = this.dialogue[category][tier];
                return lines[Math.floor(Math.random() * lines.length)];
            },

            // Logic to determine initial offer (always lowball)
            calculateOffer: function(itemRealValue, reputation) {
                // Base offer is 40-60% of real value
                let percent = 0.4 + (Math.random() * 0.2);

                // Reputation bonus
                if (reputation > 70) percent += 0.15; // Better offers for friends
                if (reputation < 30) percent -= 0.15; // Worse for suspicious

                return Math.floor(itemRealValue * percent);
            }
        };

        // --- STATE ---
        let gameState = {
            money: GAME_CONFIG.startMoney,
            round: 1,
            reputation: 50, // 0-100, 50 is neutral
            inventory: [],
            currentUnit: null,
            history: [],
            gameOver: false,
            eoPatience: 4, // Max 4 per round
            negotiationMemory: {} // Remembers offers per item
        };

        // --- DOM ELEMENTS ---
        const ui = {
            app: document.getElementById('app'),
            money: document.getElementById('ui-money'),
            round: document.getElementById('ui-round'),
            rep: document.getElementById('ui-reputation')
        };

        // --- INIT ---
        window.onload = () => {
            initGame();
        };

        function initGame() {
            console.log("Oyun Ba≈ülatƒ±ldƒ±.");
            updateHeader();
            startRound();
        }

        function updateHeader() {
            ui.money.innerText = gameState.money.toLocaleString('tr-TR') + ' ‚Ç∫';
            ui.round.innerText = gameState.round;

            let repText = "N√∂tr";
            if (gameState.reputation > 70) repText = "Dost";
            else if (gameState.reputation > 85) repText = "Ortak";
            else if (gameState.reputation < 30) repText = "≈û√ºpheli";
            else if (gameState.reputation < 15) repText = "D√º≈üman";

            ui.rep.innerText = repText;
            ui.rep.style.color = gameState.reputation < 30 ? 'var(--danger-color)' : (gameState.reputation > 70 ? 'var(--success-color)' : 'var(--text-color)');
        }

        // --- RIVALS DATA ---
        const RIVALS_DB = [
            { name: "Hurdacƒ± Rƒ±za", type: "aggressive", factor: 1.1 }, // Bids slightly over value
            { name: "Koleksiyoncu Ece", type: "smart", factor: 0.9 }, // Stops before full value
            { name: "Zengin Berk", type: "rich", factor: 1.3 }, // Overpays significantly
            { name: "√áaylak Mert", type: "random", factor: 0.7 }, // Undervalues
            { name: "Antikacƒ± Vedat", type: "smart", factor: 0.95 },
            { name: "Sosyete Pelin", type: "rich", factor: 1.2 }
        ];

        // --- GAME LOGIC ---

        function startRound() {
            gameState.availableUnits = generateStorageUnits();

            // Determine Patience based on Reputation
            if (gameState.reputation > 70) gameState.eoPatience = 4;
            else if (gameState.reputation < 30) gameState.eoPatience = 2;
            else gameState.eoPatience = 3;

            gameState.negotiationMemory = {};

            // Reset Event Modifiers
            gameState.marketModifier = 1.0;

            // Trigger Random Event (20% chance)
            if (Math.random() < 0.20 && gameState.round > 1) {
                triggerEvent();
            } else {
                checkGameOver();
            }
        }

        function checkGameOver() {
            if (gameState.money < 100 && gameState.inventory.length === 0) {
                renderGameOver();
            } else {
                renderStorageSelection();
            }
        }

        function triggerEvent() {
            const events = [
                {
                    title: "üëÆ POLƒ∞S BASKINI",
                    desc: "Polis ekipleri ka√ßak e≈üya aramasƒ± yapƒ±yor! Belgesiz ≈ü√ºpheli e≈üyalarƒ±na el konuldu.",
                    effect: () => {
                        let seized = 0;
                        gameState.inventory = gameState.inventory.filter(i => {
                            if ((i.type === 'rare' || i.type === 'legendary') && !i.certified) {
                                seized++;
                                return false; // Remove
                            }
                            return true;
                        });
                        return seized > 0 ? `${seized} adet e≈üyaya el konuldu!` : "≈û√ºpheli e≈üya bulunamadƒ±, ≈üanslƒ±sƒ±n.";
                    }
                },
                {
                    title: "üìà Pƒ∞YASA CANLANMASI",
                    desc: "Antika piyasasƒ± hareketlendi! EO bug√ºn %20 daha fazla √∂d√ºyor.",
                    effect: () => {
                        gameState.marketModifier = 1.2;
                        return "Satƒ±≈ü fiyatlarƒ± arttƒ±.";
                    }
                },
                {
                    title: "üìâ EKONOMƒ∞K DURGUNLUK",
                    desc: "Piyasa durgun. Fiyatlar d√º≈üt√º.",
                    effect: () => {
                        gameState.marketModifier = 0.8;
                        return "Satƒ±≈ü fiyatlarƒ± %20 d√º≈üt√º.";
                    }
                },
                {
                    title: "üïµÔ∏è HIRSIZ!",
                    desc: "Gece depoya hƒ±rsƒ±z girdi! Bir miktar paranƒ± √ßaldƒ±rdƒ±n.",
                    effect: () => {
                        const lost = Math.floor(gameState.money * 0.1);
                        gameState.money -= lost;
                        return `${lost} ‚Ç∫ √ßalƒ±ndƒ±.`;
                    }
                },
                {
                    title: "üéÅ Gƒ∞ZEMLƒ∞ HAYIRSEVER",
                    desc: "Zengin bir i≈ü adamƒ± sana yatƒ±rƒ±m yaptƒ±.",
                    effect: () => {
                        const gain = 2000 + (gameState.round * 500);
                        gameState.money += gain;
                        return `${gain} ‚Ç∫ kazandƒ±n!`;
                    }
                }
            ];

            const event = events[Math.floor(Math.random() * events.length)];
            const resultMsg = event.effect();

            ui.app.innerHTML = `
                <div class="screen screen-glass">
                    <h1 style="font-size:3rem; margin:0;">‚ö†Ô∏è</h1>
                    <h2 style="color:var(--accent-color);">${event.title}</h2>
                    <p style="font-size:1.2rem;">${event.desc}</p>
                    <div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:10px; margin:20px 0;">
                        <strong>SONU√á:</strong> ${resultMsg}
                    </div>
                    <button class="btn" onclick="checkGameOver()">DEVAM ET</button>
                </div>
            `;
            updateHeader();
        }

        function renderGameOver() {
            ui.app.innerHTML = `
                <div class="screen screen-glass">
                    <h1 style="color: var(--danger-color)">üö´ ƒ∞FLAS ETTƒ∞N</h1>
                    <div style="font-size:3rem; margin:20px;">üí∏</div>
                    <p>Cebinde kalan para: <span class="money">${gameState.money} ‚Ç∫</span></p>
                    <div class="speech-bubble" style="margin:20px auto; color:#333;">EO: "√úzg√ºn√ºm dostum, burasƒ± hayƒ±r kurumu deƒüil. Ba≈üka kapƒ±ya."</div>
                    <p>Ula≈üƒ±lan Tur: ${gameState.round}</p>
                    <button class="btn" onclick="location.reload()">üîÑ TEKRAR DENE</button>
                </div>
            `;
        }

        function generateStorageUnits() {
            const units = [];
            const risks = ['D√º≈ü√ºk', 'Orta', 'Y√ºksek'];

            for(let i=0; i<5; i++) {
                // Black Market Chance (3%)
                let isBlackMarket = Math.random() < 0.03;

                let riskLevel, riskLabel, name, className, desc;

                if (isBlackMarket) {
                    riskLevel = 3;
                    riskLabel = "KARA BORSA";
                    name = `Depo #${100 + i + (gameState.round * 5)} (KARA BORSA)`;
                    className = "black-market";
                    desc = "Kƒ±rmƒ±zƒ± bir ƒ±≈üƒ±k yayƒ±yor... ƒ∞√ßerisi √ßok tehlikeli g√∂r√ºn√ºyor.";
                } else {
                    riskLevel = Math.floor(Math.random() * 3);
                    riskLabel = risks[riskLevel];
                    name = `Depo #${100 + i + (gameState.round * 5)}`;
                    className = "";
                    desc = generateUnitDescription(riskLevel);
                }

                // Temporary object to generate items
                const tempUnit = { risk: riskLevel };
                const contents = generateItemsForUnit(tempUnit);

                // Calculate True Value
                const trueValue = contents.reduce((acc, item) => acc + item.realValue, 0);

                // Starting Bid Logic
                let startingBid;
                if (isBlackMarket) {
                    // Black Market: High starting bid (15k + round scaling)
                    // Even if true value is low (scam), bid starts high.
                    let basePrice = 15000 + (gameState.round * 2000);
                    startingBid = Math.floor(basePrice * (0.9 + Math.random() * 0.2));
                } else {
                    // Normal: 15-20% of true value
                    startingBid = Math.floor(trueValue * 0.15);
                    if (startingBid < 500) startingBid = 500;
                }

                units.push({
                    id: i,
                    name: name,
                    risk: riskLevel,
                    riskLabel: riskLabel,
                    startingBid: startingBid,
                    currentBid: startingBid,
                    description: desc,
                    className: className,
                    contents: contents, // Hidden items
                    trueValue: trueValue,
                    sold: false,
                    soldTo: null
                });
            }
            return units;
        }

        function generateUnitDescription(risk) {
            const descs = [
                ["Temiz g√∂r√ºn√ºyor.", "Birka√ß koli var.", "Standart ev e≈üyalarƒ±."],
                ["Karƒ±≈üƒ±k bir yƒ±ƒüƒ±n.", "Bazƒ± kutular kapalƒ±.", "Tozlu ama dolu."],
                ["Tam bir muamma.", "Ya hazine ya √ß√∂p.", "Aƒüƒ±r kutular var."]
            ];
            return descs[risk][Math.floor(Math.random() * descs[risk].length)];
        }

        function renderStorageSelection() {
            // Check if all units sold
            const allSold = gameState.availableUnits.every(u => u.sold);

            if (allSold) {
                 // If player bought nothing this round and inventory is empty, trouble?
                 // But for now, just let them go to Hub if they have items, or force next round?
                 // Logic: If all sold, show Hub button.
            }

            const containerHtml = gameState.availableUnits.map(unit => {
                let riskClass;
                if(unit.risk === 3) riskClass = 'risk-black';
                else riskClass = unit.risk === 0 ? 'risk-low' : (unit.risk === 1 ? 'risk-med' : 'risk-high');

                const canBid = gameState.money >= unit.startingBid;

                if (unit.sold) {
                    return `
                    <div class="storage-card ${unit.className}" style="opacity:0.5; filter:grayscale(1);">
                        <h3>${unit.name}</h3>
                        <div class="stamp-anim" style="opacity:1; transform:translate(-50%, -50%) rotate(-15deg) scale(1); font-size:2rem; padding:5px 20px;">SATILDI</div>
                        <p>Alan: ${unit.soldTo}</p>
                        <div style="margin-top:auto; font-weight:bold;">Son Fiyat: ${unit.currentBid} ‚Ç∫</div>
                    </div>
                    `;
                }

                return `
                <div class="storage-card ${unit.className}" onclick="${canBid ? `startAuction(${unit.id})` : ''}" style="${!canBid ? 'opacity:0.5; cursor:not-allowed' : ''}">
                    <h3>${unit.name}</h3>
                    <p>${unit.description}</p>
                    <div class="risk-badge ${riskClass}">Risk: ${unit.riskLabel}</div>
                    <div style="margin-top:auto; font-size:1.4rem; font-weight:bold; color:var(--accent-color); text-shadow:0 0 10px rgba(255,215,0,0.3)">
                        A√ßƒ±lƒ±≈ü: ${unit.startingBid} ‚Ç∫
                    </div>
                </div>
                `;
            }).join('');

            // Hub button only if player has items or wants to skip
            const showHub = gameState.inventory.length > 0 || allSold;

            ui.app.innerHTML = `
                <div class="screen">
                    <h2 style="font-size:2rem; margin-bottom:10px">üì¢ G√úN√úN ƒ∞HALESƒ∞</h2>
                    <p style="color:#aaa">Mevcut Bakiye: <span class="money">${gameState.money} ‚Ç∫</span></p>
                    <div class="storage-grid">
                        ${containerHtml}
                    </div>
                    ${showHub ? '<button class="btn" style="margin-top:30px;" onclick="startHubPhase()">üèôÔ∏è ≈ûEHRE ƒ∞N (Turu Bitir)</button>' : ''}
                </div>
            `;
        }

        // --- AUCTION SYSTEM ---
        let auction = null;

        window.startAuction = function(unitId) {
            const unit = gameState.availableUnits.find(u => u.id === unitId);
            if (unit.sold) return;

            // Pick 2 Rivals
            const shuffled = [...RIVALS_DB].sort(() => 0.5 - Math.random());
            const bidders = [
                { id: 'player', name: 'SEN', type: 'player', active: true },
                { id: 'rival1', ...shuffled[0], active: true },
                { id: 'rival2', ...shuffled[1], active: true }
            ];

            // Calculate rival limits based on true value + variance
            bidders.forEach(b => {
                if (b.type !== 'player') {
                    // Smart rivals guess closer to true value
                    // Random rivals vary wildly
                    let variance = 0.9 + (Math.random() * 0.2); // Default
                    if (b.type === 'smart') variance = 0.95 + (Math.random() * 0.1); // 0.95 - 1.05
                    if (b.type === 'rich') variance = 1.1 + (Math.random() * 0.3); // Overpay

                    b.limit = Math.floor(unit.trueValue * b.factor * variance);
                    // Ensure limit is at least starting bid + some
                    if (b.limit < unit.startingBid) b.limit = unit.startingBid + 500;
                }
            });

            auction = {
                unit: unit,
                currentBid: unit.startingBid,
                highBidder: null, // null means no one bid yet
                bidders: bidders,
                turnIndex: 0, // 0 = Player, 1 = Rival1, 2 = Rival2
                log: ["ƒ∞hale ba≈üladƒ±! A√ßƒ±lƒ±≈ü: " + unit.startingBid + " ‚Ç∫"],
                timer: null,
                ended: false
            };

            renderAuction();
        };

        function renderAuction() {
            if (!auction) return;
            const unit = auction.unit;

            // Logs
            const logHtml = auction.log.slice(-4).map(l => `<div style="margin:5px 0; color:#ddd;">${l}</div>`).join('');

            // Bidders status
            const biddersHtml = auction.bidders.map((b, idx) => {
                const isTurn = idx === auction.turnIndex && !auction.ended;
                const isHigh = auction.highBidder === b.name;
                const status = !b.active ? 'üö´ √áEKƒ∞LDƒ∞' : (isHigh ? 'üëë Lƒ∞DER' : 'Bekliyor');
                const border = isTurn ? '2px solid var(--accent-color)' : '1px solid transparent';

                return `
                <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:10px; border:${border}; opacity:${b.active ? 1 : 0.5}">
                    <div style="font-weight:bold;">${b.name}</div>
                    <div style="font-size:0.8rem;">${status}</div>
                </div>
                `;
            }).join('');

            const isPlayerTurn = auction.turnIndex === 0 && !auction.ended && auction.bidders[0].active;
            const minBid = 50;

            ui.app.innerHTML = `
                <div class="screen screen-glass">
                    <h2>üì¢ ƒ∞HALE: ${unit.name}</h2>
                    <div style="display:flex; justify-content:center; gap:20px; margin-bottom:20px;">
                        ${biddersHtml}
                    </div>

                    <div style="background:rgba(0,0,0,0.3); padding:20px; border-radius:15px; margin-bottom:20px;">
                        <div style="font-size:2.5rem; color:var(--accent-color); font-weight:bold;">${auction.currentBid} ‚Ç∫</div>
                        <div style="color:#aaa;">≈ûu anki teklif</div>
                    </div>

                    <div style="height:100px; overflow:hidden; text-align:left; padding:10px; background:rgba(0,0,0,0.2); border-radius:10px; margin-bottom:20px;">
                        ${logHtml}
                    </div>

                    <div style="display:flex; justify-content:center; gap:10px;">
                        <button class="btn" onclick="auctionBid(50)" ${!isPlayerTurn || gameState.money < auction.currentBid + 50 ? 'disabled' : ''}>+50 ‚Ç∫</button>
                        <button class="btn" onclick="auctionBid(200)" ${!isPlayerTurn || gameState.money < auction.currentBid + 200 ? 'disabled' : ''}>+200 ‚Ç∫</button>
                        <button class="btn" onclick="auctionBid(500)" ${!isPlayerTurn || gameState.money < auction.currentBid + 500 ? 'disabled' : ''}>+500 ‚Ç∫</button>
                        <button class="btn btn-danger" onclick="auctionPass()" ${!isPlayerTurn ? 'disabled' : ''}>√áEKƒ∞L üö´</button>
                    </div>

                    ${auction.ended ? '<button class="btn" style="margin-top:20px;" onclick="renderStorageSelection()">GERƒ∞ D√ñN</button>' : ''}
                </div>
            `;

            // Auto scroll log?

            // If not player turn, trigger AI logic
            if (!isPlayerTurn && !auction.ended) {
                setTimeout(processAiTurn, 1000);
            }
        }

        window.auctionBid = function(amount) {
            const player = auction.bidders[0];
            const newBid = auction.currentBid + amount;

            auction.currentBid = newBid;
            auction.highBidder = player.name;
            auction.log.push(`<strong>SEN</strong> ${newBid} ‚Ç∫ teklif verdin!`);

            nextTurn();
        };

        window.auctionPass = function() {
            auction.bidders[0].active = false;
            auction.log.push(`<strong>SEN</strong> √ßekildin.`);
            checkAuctionEnd();
            if (!auction.ended) nextTurn();
            else renderAuction();
        };

        function processAiTurn() {
            if (auction.ended) return;

            const bidder = auction.bidders[auction.turnIndex];
            if (!bidder.active) {
                nextTurn();
                return;
            }

            // AI Logic
            // If already high bidder, pass (wait) - but in this turn based system, you only get turn if you were outbid?
            // Wait, round robin logic: A -> B -> C -> A.
            // If A is high bidder, and it's A's turn, he doesn't need to bid. He just waits.
            // But usually in round robin, if everyone else passes, A wins.

            if (bidder.name === auction.highBidder) {
                // Already winning.
                // In a real auction, turns don't cycle if you are winning, others must bid.
                // But simplified: If it's my turn and I'm winning, I say nothing?
                // Or we just skip the high bidder?
                // Let's just say "Pas (Lider)" and move on, but that counts as a pass? No.
                // If I am leader, I just keep leading.
                // Let's logic: "Waiting for others..."
                // Actually easier: If it's your turn and you are High Bidder, you pass but stay active?
                // No, standard auction: Bidding goes on until NO ONE bids higher.
                // So if it comes to me and I am High Bidder, I have won?
                // Not necessarily, someone might have bid before me?
                // Let's implement: If it's my turn and I am the High Bidder, I effectively "Pass" but remain active (Hold).
                // But if everyone consecutively passes, the high bidder wins.
                // So I need to track "consecutive passes".
            }

            // Better Logic:
            // Calculate minimum bid needed (Current + 50)
            const minNeeded = auction.currentBid + 50;

            if (bidder.name === auction.highBidder) {
                 // I am leading. Do nothing.
                 auction.log.push(`${bidder.name} lider, bekliyor.`);
                 // passCount increases? No, leader doesn't count towards pass count ending auction.
                 // Actually, if it reaches leader again without anyone bidding, leader wins.
                 // So we can check if (nextPlayer == highBidder) -> Auction Ends?
                 // No, simpler:
                 // If it is my turn and I am high bidder, I implicitly "Pass/Hold".
                 nextTurn();
                 return;
            }

            if (minNeeded > bidder.limit) {
                // Too expensive
                bidder.active = false;
                auction.log.push(`${bidder.name} √ßekildi!`);
            } else {
                // Bid
                // Choose bid amount (small or jump)
                let increase = 50;
                if (bidder.type === 'aggressive' || bidder.type === 'rich') {
                     if (Math.random() < 0.3) increase = 200;
                }

                const bid = auction.currentBid + increase;

                // Check if this bid exceeds limit?
                if (bid > bidder.limit) {
                    // Try minimal bid
                    if (minNeeded <= bidder.limit) {
                        auction.currentBid = minNeeded;
                        auction.highBidder = bidder.name;
                        auction.log.push(`${bidder.name} ${minNeeded} ‚Ç∫ teklif verdi.`);
                    } else {
                        bidder.active = false;
                        auction.log.push(`${bidder.name} √ßekildi!`);
                    }
                } else {
                    auction.currentBid = bid;
                    auction.highBidder = bidder.name;
                    auction.log.push(`${bidder.name} ${bid} ‚Ç∫ teklif verdi.`);
                }
            }

            checkAuctionEnd();
            if(!auction.ended) nextTurn();
            else renderAuction();
        }

        function nextTurn() {
            // Find next active bidder
            let nextIdx = (auction.turnIndex + 1) % 3;
            let loopCount = 0;

            // Check win condition here properly
            // If only 1 active bidder remains -> Winner
            const activeBidders = auction.bidders.filter(b => b.active);
            if (activeBidders.length === 1) {
                endAuction(activeBidders[0]);
                return;
            }

            // Also, if everyone passed except High Bidder?
            // In this round-robin, if we do a full circle and no one raises, High Bidder wins.
            // But tracking that is complex.
            // Simpler: If it's High Bidder's turn, and everyone else has passed (inactive)?
            // We handled "only 1 active" above.
            // What if others are active but just checking/waiting?
            // In this simplified logic: You either BID (become leader) or WITHDRAW (inactive).
            // So "activeBidders.length === 1" is sufficient!
            // Wait, what if player just wants to "Check"? No, you must beat the bid or fold.
            // So: Bid or Fold. Perfect.

            auction.turnIndex = nextIdx;

            // If next player is inactive, skip
            while (!auction.bidders[auction.turnIndex].active) {
                auction.turnIndex = (auction.turnIndex + 1) % 3;
                loopCount++;
                if (loopCount > 4) break; // Safety
            }

            renderAuction();
        }

        function checkAuctionEnd() {
             const activeBidders = auction.bidders.filter(b => b.active);
             if (activeBidders.length === 1) {
                 endAuction(activeBidders[0]);
             } else if (activeBidders.length === 0) {
                 // Everyone quit? (Shouldn't happen if logic requires beating bid)
                 // If player quits, and rivals quit?
                 // Last high bidder wins.
                 const winnerName = auction.highBidder;
                 const winner = auction.bidders.find(b => b.name === winnerName);
                 if (winner) endAuction(winner);
                 else endAuction(null); // No one won?
             }
        }

        function endAuction(winner) {
            auction.ended = true;
            auction.unit.sold = true;

            if (winner) {
                auction.unit.soldTo = winner.name;

                if (winner.id === 'player') {
                    // Player Won
                    auction.log.push(`<div style="color:var(--success-color); font-size:1.2rem; margin-top:10px;">üèÜ ƒ∞HALEYƒ∞ KAZANDIN!</div>`);

                    // Deduct Money
                    gameState.money -= auction.currentBid;
                    gameState.currentUnit = auction.unit;

                    // Reveal Items
                    gameState.inventory.push(...auction.unit.contents); // Move hidden contents to inventory

                    // Show reveal button
                    ui.app.innerHTML += `
                        <div class="screen screen-glass" style="margin-top:20px; animation:fadeIn 0.5s;">
                            <h2>TEBRƒ∞KLER!</h2>
                            <p>${auction.currentBid} ‚Ç∫ √∂deme yapƒ±ldƒ±.</p>
                            <button class="btn" onclick="revealAuctionItems()">KUTULARI A√á üì¶</button>
                        </div>
                    `;
                    updateHeader();
                    // Don't renderAuction again, we want this static
                    return;
                } else {
                    auction.log.push(`<div style="color:var(--danger-color); margin-top:10px;">‚ùå ${winner.name} KAZANDI!</div>`);
                }
            } else {
                 auction.log.push(`ƒ∞hale iptal oldu.`);
            }

            renderAuction();
        }

        window.revealAuctionItems = function() {
            // Re-use revealItems logic but with data we already have
            const newItems = auction.unit.contents;

            const listHtml = newItems.map(item => {
                let rarityInfo = Object.values(RARITY).find(r => r.id === item.type);
                return `
                <div class="item-row rarity-${item.type}">
                    <div>
                        <strong>${item.name}</strong><br>
                        <span style="color:${rarityInfo.color}; font-size:0.8rem">${rarityInfo.label}</span>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <span style="color:#888; font-size:0.9rem">Tahmini: ???</span>
                    </div>
                </div>
                `;
            }).join('');

            ui.app.innerHTML = `
                <div class="screen">
                    <h2>DEPODAN √áIKANLAR</h2>
                    <div class="item-list">
                        ${listHtml}
                    </div>
                    <button class="btn" onclick="startHubPhase()">üèôÔ∏è ≈ûEHƒ∞R MERKEZƒ∞NE Gƒ∞T</button>
                </div>
            `;
        };

        // Old functions replaced/integrated

        // Remove old buyUnit function? No, need to keep it if referenced, but I removed references in renderStorageSelection.
        // Actually I should remove it to clean up.


        // --- EXPERT PHASE ---

        window.startExpertPhase = function() {
            renderExpert();
        };

        function renderExpert() {
             const listHtml = gameState.inventory.map(item => {
                let rarityInfo = Object.values(RARITY).find(r => r.id === item.type);
                const fee = Math.max(50, Math.floor(item.realValue * 0.05));
                const canAfford = gameState.money >= fee;

                return `
                <div class="item-row rarity-${item.type}">
                    <div>
                        <strong>${item.name}</strong> ${item.certified ? '‚úÖ' : ''}<br>
                        <span style="color:${rarityInfo.color}; font-size:0.8rem">${rarityInfo.label}</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        ${item.certified
                            ? `<span style="color:var(--success-color); font-weight:bold;">DEƒûER: ${item.realValue} ‚Ç∫</span>`
                            : `<button class="btn" style="font-size:0.8rem" onclick="certifyItem(${item.id}, ${fee})" ${!canAfford ? 'disabled' : ''}>ONAYLAT (-${fee}‚Ç∫)</button>`
                        }
                    </div>
                </div>
                `;
            }).join('');

            ui.app.innerHTML = `
                <div class="screen screen-glass">
                    <h2>üßê EKSPERTƒ∞Z B√úROSU</h2>
                    <p>Burada ≈ü√ºpheli e≈üyalarƒ±n orijinalliƒüini kanƒ±tlayabilirsin. Onaylƒ± e≈üyalar EO kar≈üƒ±sƒ±nda daha deƒüerli olur.</p>
                    <p>Paran: <span class="money">${gameState.money} ‚Ç∫</span></p>
                    <div class="item-list">
                        ${listHtml}
                    </div>
                    <button class="btn" onclick="startHubPhase()">üèôÔ∏è ≈ûEHRE D√ñN</button>
                </div>
            `;
        }

        window.certifyItem = function(id, fee) {
            if (gameState.money < fee) return;

            const item = gameState.inventory.find(i => i.id === id);
            gameState.money -= fee;

            // 25% Chance for Fake/Junk
            if (Math.random() < 0.25) {
                item.type = 'junk';
                item.name = item.name + " (SAHTE)";
                item.realValue = Math.floor(item.realValue * 0.01); // 1% value
                alert("EKSPERT RAPORU: Bu √ºr√ºn SAHTE √ßƒ±ktƒ±! Deƒüeri d√º≈üt√º.");
            }

            item.certified = true;

            updateHeader();
            renderExpert();
        };

        // --- SHOP & NEGOTIATION ---

        let negotiationState = null;
        let selectedForBulk = new Set();

        window.startShopPhase = function() {
            selectedForBulk.clear();
            renderShop();
        };

        function toggleBulkSelection(id) {
            if (selectedForBulk.has(id)) selectedForBulk.delete(id);
            else selectedForBulk.add(id);
            renderShop(); // Re-render to update buttons state if needed
        }

        window.sellBulk = function() {
            if (selectedForBulk.size === 0) return;

            let totalValue = 0;
            const itemsToSell = [];

            gameState.inventory.forEach(item => {
                if(selectedForBulk.has(item.id)) {
                    // Bulk price is 60% of base estimate (approx realValue * 0.6)
                    totalValue += Math.floor(item.realValue * 0.6);
                    itemsToSell.push(item.id);
                }
            });

            if (confirm(`${itemsToSell.length} adet e≈üyayƒ± toplam ${totalValue} ‚Ç∫ kar≈üƒ±lƒ±ƒüƒ±nda satmak istiyor musun?`)) {
                gameState.money += totalValue;
                gameState.inventory = gameState.inventory.filter(i => !selectedForBulk.has(i.id));
                selectedForBulk.clear();
                updateHeader();
                renderShop();
            }
        };

        function renderShop() {
            // If inventory empty, suggest leaving
            if (gameState.inventory.length === 0) {
                ui.app.innerHTML = `
                    <div class="screen screen-glass">
                        <h2>üè™ D√úKKAN BO≈û</h2>
                        <p>Satacak bir ≈üeyin kalmadƒ±.</p>
                        <button class="btn" onclick="startHubPhase()">üèôÔ∏è ≈ûEHRE D√ñN</button>
                    </div>
                `;
                return;
            }

            if (negotiationState) {
                renderNegotiation();
                return;
            }

            const listHtml = gameState.inventory.map(item => {
                let rarityInfo = Object.values(RARITY).find(r => r.id === item.type);
                const isSelected = selectedForBulk.has(item.id);

                return `
                <div class="item-row rarity-${item.type}">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <input type="checkbox" onchange="toggleBulkSelection(${item.id})" ${isSelected ? 'checked' : ''}>
                        <div>
                            <strong>${item.name}</strong> ${item.certified ? '<span class="certified-badge">ONAYLI</span>' : ''}<br>
                            <span style="color:${rarityInfo.color}; font-size:0.8rem">${rarityInfo.label}</span>
                        </div>
                    </div>
                    <button class="btn" style="font-size:0.8rem" onclick="initNegotiation(${item.id})">SAT üí∞</button>
                </div>
                `;
            }).join('');

            const bulkCount = selectedForBulk.size;

            ui.app.innerHTML = `
                <div class="screen screen-glass">
                    <h2>üè™ EO'NUN D√úKKANI</h2>
                    <p>EO: "${EO_AI.getLine('greeting', gameState.reputation)}"</p>
                    <div style="text-align:right; margin-bottom:10px;">
                        <button class="btn btn-purple" onclick="sellBulk()" ${bulkCount === 0 ? 'disabled' : ''}>
                            üóëÔ∏è SE√áƒ∞LENLERƒ∞ TOPLU SAT (%60)
                        </button>
                    </div>
                    <div class="item-list">
                        ${listHtml}
                    </div>
                    <button class="btn" onclick="startHubPhase()">üèôÔ∏è ≈ûEHRE D√ñN</button>
                </div>
            `;
        }

        window.initNegotiation = function(itemId) {
            const item = gameState.inventory.find(i => i.id === itemId);

            // Check Memory and handle "Return with Certificate" logic
            let mem = gameState.negotiationMemory[itemId];

            // Special case: Player certified the item AFTER a failed negotiation
            // Logic: Memory exists, was NOT certified in memory, but IS certified now
            if (mem && !mem.wasCertified && item.certified) {
                 // Reset memory for this item effectively to allow re-pricing
                 delete gameState.negotiationMemory[itemId];
                 mem = null;
            }

            if (mem) {
                negotiationState = {
                    item: item,
                    currentOffer: mem.offer,
                    status: 'active',
                    dialogue: mem.dialogue || "Kaldƒ±ƒüƒ±mƒ±z yerden devam edelim."
                };
            } else {
                // Determine dialogue tone based on reputation
                let repTier = 'neutral';
                if (gameState.reputation > 70) repTier = 'friendly';
                else if (gameState.reputation < 30) repTier = 'suspicious';

                let initialOffer = EO_AI.calculateOffer(item.realValue, gameState.reputation);
                let startDialogue = EO_AI.getLine('inspecting', gameState.reputation);

                // Logic for rare/uncertified items
                if ((item.type === 'rare' || item.type === 'legendary') && !item.certified) {
                    // Suspicion Check logic
                    let suspicionChance = 0.8; // Base 80%
                    if (gameState.reputation > 70) suspicionChance = 0.2; // 20% for Friends
                    if (gameState.reputation > 90) suspicionChance = 0.05; // 5% for Partners

                    if (Math.random() < suspicionChance) {
                        // SUSPICIOUS: Lowball hard
                        initialOffer = Math.floor(initialOffer * 0.3);
                        if(repTier === 'friendly') {
                            startDialogue = "Dostum bu √ßok deƒüerli g√∂r√ºn√ºyor ama sahteleri √ßok. Bir belgen var mƒ±?";
                        } else if (repTier === 'suspicious') {
                             startDialogue = "Bunu √ßaldƒ±n mƒ±? Belgesiz hi√ßbir ≈üey almam, ya da hurda parasƒ±na alƒ±rƒ±m.";
                        } else {
                            startDialogue = "Bu ne? Sahte gibi duruyor. Kanƒ±tƒ±n var mƒ±? Yoksa sana ancak √ß√∂p parasƒ± veririm.";
                        }
                    } else {
                        // TRUSTED: Treat as if certified (better offer, normal dialogue)
                        // Slightly reduce offer compared to certified but much better than lowball
                        initialOffer = Math.floor(item.realValue * (0.6 + Math.random() * 0.2));

                        if(repTier === 'friendly') {
                            startDialogue = "G√ºzel par√ßa! Senden geldiƒüi i√ßin orijinalliƒüine g√ºveniyorum.";
                        } else {
                            startDialogue = "Riskli bir par√ßa ama sana g√ºveneceƒüim. Fiyatƒ±m bu.";
                        }
                    }
                } else if (item.certified) {
                     initialOffer = Math.floor(initialOffer * 1.5); // Better offer

                     // Check if this is a "Return with Certificate" moment
                     // We know it is because we cleared 'mem' above if it was a return.
                     // But we want specific dialogue if it's a return.
                     // A simple heuristic: If the offer is much higher than what it would be uncertified.
                     // Better: Just check if we had memory before we cleared it? No, too late.
                     // Let's rely on standard certified lines, OR add a flag.

                     if (gameState.negotiationMemory[itemId] === undefined) {
                         // It could be a fresh item OR a cleared memory item.
                         // We can't easily distinguish without more state.
                         // But we can say "Belgeletmi≈üsin" generally if it is certified.

                         if(repTier === 'friendly') {
                             startDialogue = "Belgeletmi≈üsin! ƒ∞≈üte ≈üimdi ciddile≈üebiliriz dostum.";
                         } else {
                             startDialogue = "Belgeletmi≈üsin, ≈üimdi ciddile≈üebiliriz.";
                         }
                     }
                }

                negotiationState = {
                    item: item,
                    currentOffer: initialOffer,
                    status: 'active', // active, sold, failed
                    lastMove: 'start',
                    dialogue: startDialogue
                };

                // Save immediately
                saveNegotiationState();
            }

            renderNegotiation();
        };

        function saveNegotiationState() {
            if (negotiationState && negotiationState.item) {
                gameState.negotiationMemory[negotiationState.item.id] = {
                    offer: negotiationState.currentOffer,
                    dialogue: negotiationState.dialogue,
                    wasCertified: negotiationState.item.certified // Store this to detect changes later
                };
            }
        }

        function renderNegotiation() {
            const state = negotiationState;
            const item = state.item;
            const rarityInfo = Object.values(RARITY).find(r => r.id === item.type);
            const playerKnowsValue = item.certified;

            // Patience Visualization
            let patienceHtml = '';
            for(let i=0; i<4; i++) {
                patienceHtml += (i < gameState.eoPatience) ? 'üî¥ ' : '‚ö™ ';
            }

            const patienceLow = gameState.eoPatience <= 0;

            ui.app.innerHTML = `
                <div class="screen screen-glass" style="max-width:1000px; padding:0;">
                    <div class="scene-container">
                        <div class="scene-overlay"></div>
                        <div class="eo-avatar-container">
                             <div class="eo-avatar">üë∫</div>
                             <div class="speech-bubble">"${state.dialogue}"</div>
                             <div style="margin-top:10px; font-size:1.2rem; background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:10px;">
                                SABIR: ${patienceHtml}
                             </div>
                        </div>

                        <div class="negotiation-desk">
                            <div class="desk-item">
                                <h3 style="margin:0; color:var(--accent-color)">${item.name}</h3>
                                <div style="font-size:0.8rem; opacity:0.8">${rarityInfo.label} ${item.certified ? '‚úÖ' : ''}</div>
                                <div style="margin-top:5px; font-weight:bold; color:var(--success-color)">TEKLƒ∞F: ${state.currentOffer} ‚Ç∫</div>
                                ${playerKnowsValue ? `<div style="font-size:0.7rem; color:#aaa">Ger√ßek Deƒüer: ${item.realValue} ‚Ç∫</div>` : ''}
                            </div>

                            <div class="desk-actions">
                                <button class="btn" onclick="actionAccept()">‚úÖ KABUL (${state.currentOffer} ‚Ç∫)</button>
                                <button class="btn" onclick="showCounterInput()" ${patienceLow ? 'disabled' : ''}>üí¨ PAZARLIK</button>
                                <button class="btn btn-purple" onclick="actionBluff()" ${patienceLow ? 'disabled' : ''}>üé≤ BL√ñF</button>
                                <button class="btn btn-danger" onclick="actionThreaten()" ${patienceLow ? 'disabled' : ''}>ü§¨ TEHDƒ∞T</button>
                                <button class="btn" style="background:transparent; border:1px solid #555;" onclick="actionCancel()">‚ùå VAZGE√á</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        window.actionAccept = function() {
            // Sell item
            gameState.money += negotiationState.currentOffer;

            // Remove item
            gameState.inventory = gameState.inventory.filter(i => i.id !== negotiationState.item.id);
            // Clear from memory as it's sold
            if (gameState.negotiationMemory[negotiationState.item.id]) {
                delete gameState.negotiationMemory[negotiationState.item.id];
            }

            // Reputation small boost for easy deal
            changeReputation(1);

            negotiationState = null;
            updateHeader();
            renderShop();
        };

        window.actionCancel = function() {
            saveNegotiationState();
            negotiationState = null;
            renderShop();
        };

        window.showCounterInput = function() {
            const currentOffer = negotiationState.currentOffer;
            const promptAmount = prompt("Kar≈üƒ± teklifin nedir? (Sadece sayƒ±)", currentOffer);
            if (promptAmount) {
                const val = parseInt(promptAmount);
                if (!isNaN(val)) {
                    processCounterOffer(val);
                }
            }
        };

        function processCounterOffer(playerOffer) {
            const state = negotiationState;
            const item = state.item;
            const realValue = item.realValue;

            // Logic: Is the offer reasonable?
            let repBonus = (gameState.reputation - 50) / 100; // -0.5 to 0.5

            // Apply Market Modifier
            let marketMod = gameState.marketModifier || 1.0;

            let maxTolerable = realValue * (1.0 + repBonus) * marketMod;

            // Certification Logic: If rare/legendary and NOT certified, he won't pay near full value
            // unless forced or convinced.
            if ((item.type === 'rare' || item.type === 'legendary') && !item.certified) {
                // If Friendly, he is slightly more lenient
                if (gameState.reputation > 70) maxTolerable = realValue * 0.65;
                else maxTolerable = realValue * 0.5;
            }

            // Hidden Interest Mechanic
            if (item.eoInterest === 2) {
                // He really wants it, so he will tolerate higher prices eventually
                maxTolerable *= 1.5;
            } else if (item.eoInterest === 1) {
                maxTolerable *= 1.2;
            }

            if (playerOffer <= state.currentOffer) {
                state.dialogue = "Daha d√º≈ü√ºk teklif mi? Kafan mƒ± g√ºzel? Neyse, kabul.";
                state.currentOffer = playerOffer;
                renderNegotiation();
                return;
            }

            if (playerOffer <= maxTolerable) {
                // Success chance based on how greedy the player is
                const greedFactor = playerOffer / realValue; // 1.0 = fair, 1.2 = pushing it
                // Friend bonus: easier to convince
                let successChanceModifier = (gameState.reputation - 50) / 200; // +/- 0.25

                const roll = Math.random();

                if (roll > (greedFactor - 0.5 - successChanceModifier)) {
                    // Accepted
                    state.currentOffer = playerOffer;

                    if (item.eoInterest === 2) {
                         state.dialogue = "Tamam tamam, alƒ±yorum. Sakƒ±n kimseye bu fiyattan bahsetme.";
                    } else {
                         state.dialogue = EO_AI.getLine('accept', gameState.reputation);
                    }
                } else {
                    // Counter-counter
                    const middleGround = Math.floor((state.currentOffer + playerOffer) / 2);
                    state.currentOffer = middleGround;
                    state.dialogue = EO_AI.getLine('lowball', gameState.reputation);
                    gameState.eoPatience -= 1;
                }
            } else {
                // Insultingly high
                state.dialogue = EO_AI.getLine('reject', gameState.reputation);
                gameState.eoPatience -= 1;
            }

            saveNegotiationState();
            checkPatience();
            renderNegotiation();
        }

        window.actionBluff = function() {
            const state = negotiationState;
            // Bluff mechanics: Try to increase perceived value
            const roll = Math.random();
            const successChance = 0.4 + (gameState.reputation / 200);

            if (roll < successChance) {
                // Success
                state.currentOffer = Math.floor(state.currentOffer * 1.5);
                state.dialogue = "Hmm... Ger√ßekten mi? Bak bunu fark etmemi≈ütim. Fiyatƒ± arttƒ±rƒ±yorum.";
            } else {
                // Fail
                state.dialogue = "Kimi kandƒ±rƒ±yorsun sen? Bu numara bana s√∂kmez.";
                gameState.eoPatience -= 2;
                changeReputation(-5);
            }
            saveNegotiationState();
            checkPatience();
            renderNegotiation();
        };

        window.actionThreaten = function() {
            const state = negotiationState;
            // High risk
            const roll = Math.random();
            if (roll > 0.7) {
                // Success: Force max value
                state.currentOffer = Math.floor(state.item.realValue * 1.2);
                state.dialogue = EO_AI.getLine('threatResponse');
                changeReputation(-10); // Reputation hit even if successful
            } else {
                // Fail: EO ends negotiation
                state.dialogue = "Defol d√ºkkanƒ±mdan!";
                gameState.eoPatience = 0;
            }
            saveNegotiationState();
            checkPatience();
            renderNegotiation();
        };

        function checkPatience() {
            if (gameState.eoPatience <= 0) {
                // Force sell at low price or kick out?
                // For now, let's say he forces the last offer or kicks out.
                // Let's make him withdraw the offer and offer a pity amount (scrap value).
                negotiationState.dialogue = "Sabrƒ±mƒ± ta≈üƒ±rdƒ±n. Ya bu fiyata alƒ±rsƒ±n ya da defolursun.";
                // Don't nuke the offer completely to 0, just leave it as last offer, but he refuses to negotiate more.
                // Reverting logic: "e≈üyalara verdiƒüi son teklifi ... sƒ±fƒ±rlanmasƒ±n"
                // But if he gets angry, does he lower it?
                // The prompt says: "e≈üyalara verdiƒüi son teklifi ve sabrƒ± vazge√ß tu≈üuna tƒ±klayƒ±nca sƒ±fƒ±rlanmasƒ±n"
                // It doesn't explicitly say we can't lower it on failed negotiations.
                // But usually "Sabrƒ±mƒ± ta≈üƒ±rdƒ±n" means take it or leave it.
                // I will keep the current offer but prevent further actions (handled in renderNegotiation via disabled buttons).
            }
        }

        // --- HELPERS ---
        function changeReputation(amount) {
            gameState.reputation = Math.min(100, Math.max(0, gameState.reputation + amount));
        }

        function finishRound() {
            gameState.round++;
            gameState.availableUnits = [];
            ui.app.innerHTML = `
                <div class="screen">
                    <h2>TUR TAMAMLANDI</h2>
                    <p>Bug√ºnk√º hasƒ±latƒ± topladƒ±n.</p>
                    <p class="money" style="font-size:2rem">${gameState.money} ‚Ç∫</p>
                    <button class="btn" onclick="startRound()">SONRAKƒ∞ TUR</button>
                </div>
            `;
            updateHeader();
        }

        window.buyUnit = function(id) {
            const unit = gameState.availableUnits.find(u => u.id === id);
            if(gameState.money < unit.price) return;

            gameState.money -= unit.price;
            gameState.currentUnit = unit;
            updateHeader();

            // Generate items
            const newItems = generateItemsForUnit(unit);
            gameState.inventory.push(...newItems);

            revealItems(newItems);
        };

        function generateItemsForUnit(unit) {
            const itemCount = 3 + Math.floor(Math.random() * 3); // 3-5 items
            const items = [];

            for(let i=0; i<itemCount; i++) {
                // Determine rarity based on risk
                let roll = Math.random();
                let chosenType = 'junk';

                if (unit.risk === 3) { // Black Market: High Risk / High Reward
                    // 40% Junk, 30% Rare, 30% Legendary
                    if (roll < 0.40) chosenType = 'junk';
                    else if (roll < 0.70) chosenType = 'rare';
                    else chosenType = 'legendary';
                } else if (unit.risk === 0) { // Low Risk: Mostly Common (0.4-0.95), some Junk (<0.4), rare Rare (>0.95)
                    if (roll < 0.40) chosenType = 'junk';
                    else if (roll < 0.95) chosenType = 'common';
                    else chosenType = 'rare'; // 5% Rare, 0% Legendary
                } else if (unit.risk === 1) { // Med Risk: Balanced
                    if (roll < 0.30) chosenType = 'junk';
                    else if (roll < 0.85) chosenType = 'common';
                    else if (roll < 0.985) chosenType = 'rare'; // 13.5% Rare
                    else chosenType = 'legendary'; // 1.5% Legendary (Very rare)
                } else { // High Risk: High Junk, but potential for Rare/Legendary
                    if (roll < 0.50) chosenType = 'junk'; // 50% Junk
                    else if (roll < 0.85) chosenType = 'common'; // 35% Common
                    else if (roll < 0.98) chosenType = 'rare'; // 13% Rare
                    else chosenType = 'legendary'; // 2% Legendary
                }

                const possibleItems = ITEMS_DB.filter(x => x.type === chosenType);
                const template = possibleItems[Math.floor(Math.random() * possibleItems.length)];

                // Variation in value
                const valueVariation = 0.8 + (Math.random() * 0.4); // +/- 20%
                const finalValue = Math.floor(template.baseValue * valueVariation);

                items.push({
                    ...template,
                    realValue: finalValue,
                    eoInterest: Math.random() > 0.8 ? 2 : (Math.random() > 0.5 ? 1 : 0), // 0=None, 1=Mild, 2=High
                    id: Date.now() + i
                });
            }
            return items;
        }

        function revealItems(newItems) {
            const listHtml = newItems.map(item => {
                let rarityInfo = Object.values(RARITY).find(r => r.id === item.type);
                return `
                <div class="item-row rarity-${item.type}">
                    <div>
                        <strong>${item.name}</strong><br>
                        <span style="color:${rarityInfo.color}; font-size:0.8rem">${rarityInfo.label}</span>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <span style="color:#888; font-size:0.9rem">Tahmini: ???</span>
                    </div>
                </div>
                `;
            }).join('');

            ui.app.innerHTML = `
                <div class="screen">
                    <h2>DEPODAN √áIKANLAR</h2>
                    <div class="item-list">
                        ${listHtml}
                    </div>
                    <button class="btn" onclick="startHubPhase()">üèôÔ∏è ≈ûEHƒ∞R MERKEZƒ∞NE Gƒ∞T</button>
                </div>
            `;
        }

        window.startHubPhase = function() {
            renderHub();
        };

        function renderHub() {
             ui.app.innerHTML = `
                <div class="screen">
                    <h2>üèôÔ∏è ≈ûEHƒ∞R MERKEZƒ∞</h2>
                    <p>Ne yapmak istersin?</p>

                    <div class="hub-menu">
                        <div class="hub-card" onclick="startShopPhase()">
                            <div class="hub-icon">üè™</div>
                            <div class="hub-title">EO'nun D√ºkkanƒ±</div>
                            <div>E≈üyalarƒ± sat ve pazarlƒ±k yap.</div>
                        </div>

                        <div class="hub-card" onclick="startExpertPhase()">
                            <div class="hub-icon">üßê</div>
                            <div class="hub-title">Ekspertiz</div>
                            <div>E≈üyalarƒ± onaylat ve deƒüerini √∂ƒüren.</div>
                        </div>

                        <div class="hub-card" onclick="finishRound()" style="border-color:var(--success-color)">
                            <div class="hub-icon">üí§</div>
                            <div class="hub-title">G√ºn√º Bitir</div>
                            <div>Sonraki tura ge√ß.</div>
                        </div>
                    </div>
                </div>
            `;
        }

    </script>
</body>
</html>
