<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DepoE: EO'nun D√ºkkanƒ±</title>
    <style>
        :root {
            --bg-color: #0f0c29;
            --bg-gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --text-color: #ffffff;
            --accent-color: #ffd700; /* Gold */
            --danger-color: #ff4b4b;
            --success-color: #00e676;
            --eo-color: #d500f9;
            --black-market-color: #9d00ff;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            background-size: cover;
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* UTILS - GLASSMORPHISM */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

        .hidden { display: none !important; }

        .btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            padding: 12px 24px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            margin: 5px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            backdrop-filter: blur(4px);
        }
        .btn:hover {
            background: var(--accent-color);
            color: #000;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }
        .btn-danger:hover {
             background: var(--danger-color);
             box-shadow: 0 5px 15px rgba(255, 75, 75, 0.4);
        }
        .btn-purple:hover {
            background: var(--eo-color);
            color: white;
            box-shadow: 0 5px 15px rgba(213, 0, 249, 0.4);
        }

        .btn:disabled {
            border-color: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.3);
            cursor: not-allowed;
            background: rgba(0,0,0,0.2);
            transform: none;
            box-shadow: none;
        }

        /* HEADER */
        header {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(15px);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--glass-border);
            z-index: 100;
        }
        .stats {
            display: flex;
            gap: 25px;
        }
        .stat-box {
            text-align: right;
        }
        .stat-label {
            color: rgba(255,255,255,0.6);
            font-size: 0.75rem;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .money { color: var(--success-color); font-weight: bold; }

        .logo {
            font-weight: 900;
            font-size: 1.8rem;
            background: linear-gradient(to right, #ffd700, #ff8c00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        /* MAIN CONTENT AREA */
        main {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Changed from center to allow scrolling if needed */
        }

        /* SCREENS */
        .screen {
            width: 100%;
            max-width: 900px;
            text-align: center;
            animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1);
            padding: 30px;
            margin-top: 20px;
        }

        /* Glass Panel Container for Screens */
        .screen-glass {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: var(--shadow);
            padding: 40px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); scale: 0.95; }
            to { opacity: 1; transform: translateY(0); scale: 1; }
        }

        /* STORAGE SELECTION */
        .storage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        .storage-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            padding: 20px;
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 200px;
            position: relative;
            overflow: hidden;
        }
        .storage-card:hover {
            transform: translateY(-10px);
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-color);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        }
        .storage-card h3 { margin-top: 0; color: var(--accent-color); }

        .storage-card.black-market {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            border-color: #ff0000;
            color: #e0e0e0;
            font-weight: 800;
            box-shadow: 0 0 20px rgba(139, 0, 0, 0.5);
            animation: pulse-red 2s infinite;
        }
        .storage-card.black-market h3 { color: #ff0000; }
        .storage-card.black-market p { font-weight: 800; }

        .storage-card.black-market .unit-price {
            color: #ff0000 !important;
            text-shadow: 0 0 15px rgba(255, 0, 0, 0.8) !important;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 20px #8b0000; }
            50% { box-shadow: 0 0 35px #ff0000; }
            100% { box-shadow: 0 0 20px #8b0000; }
        }

        .risk-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-top: 10px;
        }
        .risk-low { background: rgba(0, 230, 118, 0.2); color: #00e676; }
        .risk-med { background: rgba(255, 215, 0, 0.2); color: #ffd700; }
        .risk-high { background: rgba(255, 75, 75, 0.2); color: #ff4b4b; }
        .risk-black { background: rgba(0, 0, 0, 0.9); color: #ff0000; }

        /* ITEM REVEAL & LISTS */
        .item-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 30px 0;
            text-align: left;
        }
        .item-row {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px 20px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid transparent;
            transition: all 0.2s;
        }
        .item-row:hover { background: rgba(255,255,255,0.05); }

        .rarity-junk { border-color: #9e9e9e; }
        .rarity-common { border-color: var(--success-color); }
        .rarity-rare { border-color: var(--accent-color); }
        .rarity-legendary { border-color: #ffeb3b; background: linear-gradient(90deg, rgba(255, 235, 59, 0.1), transparent); }

        .certified-badge {
            background: var(--accent-color);
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 8px;
            vertical-align: middle;
        }

        /* NEGOTIATION SCENE */
        .scene-container {
            display: flex;
            flex-direction: column;
            height: 500px;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            background: url('https://images.unsplash.com/photo-1550523092-234293e50669?q=80&w=2070&auto=format&fit=crop') center/cover no-repeat;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.8);
            border: 1px solid var(--glass-border);
        }

        /* Dark overlay for the background image */
        .scene-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 12, 41, 0.7);
            z-index: 1;
        }

        .eo-avatar-container {
            z-index: 2;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
        }

        .eo-avatar {
            font-size: 80px;
            background: radial-gradient(circle, rgba(156, 39, 176, 0.5) 0%, rgba(0,0,0,0) 70%);
            padding: 20px;
            border-radius: 50%;
            animation: float 3s ease-in-out infinite;
            text-shadow: 0 0 30px var(--eo-color);
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .speech-bubble {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 15px 25px;
            border-radius: 20px;
            border-bottom-left-radius: 0;
            max-width: 60%;
            margin-top: 10px;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            position: relative;
            z-index: 3;
            text-align: left;
        }
        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            border-width: 10px 10px 0;
            border-style: solid;
            border-color: rgba(255, 255, 255, 0.95) transparent;
        }

        .negotiation-desk {
            z-index: 2;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            padding: 20px;
            border-top: 1px solid var(--glass-border);
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .desk-item {
            flex: 1;
            text-align: left;
        }

        .desk-actions {
            flex: 2;
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-end;
            gap: 10px;
        }

        /* HUB MENU */
        .hub-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }

        .hub-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 30px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .hub-card:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-5px);
            border-color: var(--accent-color);
        }
        .hub-icon { font-size: 3rem; }
        .hub-title { font-size: 1.2rem; font-weight: bold; }

        /* AUCTION SCREEN */
        .auction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .auction-main {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .auction-visual {
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            padding: 30px;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 2px solid var(--glass-border);
        }
        .current-bid-display {
            font-size: 4rem;
            font-weight: 900;
            color: var(--success-color);
            text-shadow: 0 0 30px rgba(0, 230, 118, 0.4);
        }
        .timer-display {
            font-size: 1.5rem;
            color: var(--danger-color);
            font-weight: bold;
            margin-top: 10px;
            height: 30px;
        }

        .opponents-grid {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        .opponent-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            padding: 10px;
            border-radius: 12px;
            width: 80px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
        }
        .opponent-card.active-bidder {
            border-color: var(--accent-color);
            background: rgba(255, 215, 0, 0.1);
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        .opponent-card.folded {
            opacity: 0.3;
            filter: grayscale(1);
        }
        .opponent-avatar { font-size: 2.5rem; }
        .opponent-name { font-size: 0.7rem; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .last-action {
            position: absolute;
            top: -10px; right: -10px;
            background: var(--accent-color);
            color: #000;
            font-size: 0.7rem;
            padding: 2px 5px;
            border-radius: 5px;
            font-weight: bold;
            display: none;
        }

        .bid-log {
            background: rgba(0,0,0,0.5);
            height: 150px;
            overflow-y: auto;
            border-radius: 10px;
            padding: 10px;
            text-align: left;
            font-family: monospace;
            font-size: 0.9rem;
            border: 1px solid var(--glass-border);
        }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px; }
        .log-entry.high-bid { color: var(--success-color); font-weight: bold; }
        .log-entry.fold { color: var(--danger-color); font-style: italic; }

        .player-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        /* SPEECH BUBBLES FOR AUCTION */
        .mini-bubble {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--accent-color);
            color: #fff;
            padding: 8px 12px;
            border-radius: 12px;
            border-bottom-left-radius: 0;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 100;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
            box-shadow: 0 0 15px var(--accent-color);
            text-shadow: none;
            font-weight: normal;
        }

        .mini-bubble::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 0;
            border-width: 6px 6px 0;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.9) transparent;
        }

        @keyframes popIn {
            from { opacity: 0; transform: translateX(-50%) scale(0.5); }
            to { opacity: 1; transform: translateX(-50%) scale(1); }
        }

    </style>
</head>
<body>

    <header>
        <div class="logo">DepoE üì¶</div>
        <div class="stats">
            <div class="stat-box">
                <span class="stat-label">üóìÔ∏è TUR</span><br>
                <span id="ui-round">1</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">üí∞ BAKƒ∞YE</span><br>
                <span id="ui-money" class="money">1000 ‚Ç∫</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">ü§ù ƒ∞Tƒ∞BAR</span><br>
                <span id="ui-reputation">N√∂tr</span>
            </div>
        </div>
    </header>

    <main id="app">
        <!-- Screens will be injected here by JS -->
        <div id="loading" class="screen">
            <h2>Y√ºkleniyor...</h2>
        </div>
    </main>

    <script>
        // --- CONFIG & CONSTANTS ---
        const GAME_CONFIG = {
            startMoney: 2000, // Enough for a low tier unit
            maxRounds: 999, // Infinite for now
        };

        const RARITY = {
            JUNK: { id: 'junk', label: 'Hurda', color: '#9e9e9e', mult: 0.5 },
            COMMON: { id: 'common', label: 'Sƒ±radan', color: '#4caf50', mult: 1.0 },
            RARE: { id: 'rare', label: 'Nadir', color: '#ff9800', mult: 2.5 },
            LEGENDARY: { id: 'legendary', label: 'Efsanevi', color: '#ffeb3b', mult: 10.0 }
        };

        const ITEMS_DB = [
            // JUNK
            { name: "Eski Gazete Yƒ±ƒüƒ±nƒ±", type: "junk", baseValue: 20 },
            { name: "Kƒ±rƒ±k Sandalye", type: "junk", baseValue: 50 },
            { name: "Paslƒ± Bisiklet Tekerleƒüi", type: "junk", baseValue: 30 },
            { name: "K√ºfl√º Kitaplar", type: "junk", baseValue: 40 },
            { name: "Tek Ayakkabƒ±", type: "junk", baseValue: 10 },
            { name: "Bozuk Vantilat√∂r", type: "junk", baseValue: 80 },
            { name: "Tek Teylik (Sol)", type: "junk", baseValue: 5 },
            { name: "Bo≈ü Yoƒüurt Kaplarƒ±", type: "junk", baseValue: 10 },
            { name: "D√ºƒü√ºm√º √á√∂z√ºlemeyen Kablo Yumaƒüƒ±", type: "junk", baseValue: 25 },
            { name: "Kƒ±rƒ±k ≈ûemsiye", type: "junk", baseValue: 15 },
            { name: "Tarihi Ge√ßmi≈ü Konserveler", type: "junk", baseValue: 30 },
            { name: "Patlak Futbol Topu", type: "junk", baseValue: 20 },
            { name: "√áatlak Plastik Kova", type: "junk", baseValue: 10 },
            { name: "Eski Takvim Yapraklarƒ±", type: "junk", baseValue: 5 },

            // COMMON
            { name: "ƒ∞kinci El Mikrodalga", type: "common", baseValue: 400 },
            { name: "Ah≈üap Sehpa", type: "common", baseValue: 300 },
            { name: "Kullanƒ±lmƒ±≈ü Ders Kitaplarƒ±", type: "common", baseValue: 250 },
            { name: "Porselen Yemek Takƒ±mƒ± (Eksik)", type: "common", baseValue: 600 },
            { name: "√áalƒ±≈üan Tost Makinesi", type: "common", baseValue: 350 },
            { name: "Balƒ±k Oltasƒ±", type: "common", baseValue: 500 },
            { name: "Eski Model √út√º", type: "common", baseValue: 200 },
            { name: "T√ºpl√º Televizyon", type: "common", baseValue: 300 },
            { name: "Elektrikli Battaniye", type: "common", baseValue: 450 },
            { name: "Dantelli Sehpa √ñrt√ºs√º", type: "common", baseValue: 150 },
            { name: "Mangal Takƒ±mƒ± (Az Kullanƒ±lmƒ±≈ü)", type: "common", baseValue: 550 },
            { name: "Eski Ansiklopedi Seti", type: "common", baseValue: 200 },
            { name: "Diki≈ü Makinesi", type: "common", baseValue: 700 },
            { name: "Plastik Bah√ße Sandalyesi", type: "common", baseValue: 120 },
            { name: "Saz (Baƒülama)", type: "common", baseValue: 800 },
            { name: "Bavul Dolusu Kƒ±yafet", type: "common", baseValue: 400 },

            // RARE
            { name: "G√ºm√º≈ü √áatal Bƒ±√ßak Seti", type: "rare", baseValue: 5000 },
            { name: "1990 Yapƒ±mƒ± Oyun Konsolu", type: "rare", baseValue: 6500 },
            { name: "ƒ∞mzalƒ± Futbol Formasƒ±", type: "rare", baseValue: 8000 },
            { name: "Antika Cep Saati", type: "rare", baseValue: 9500 },
            { name: "Profesyonel Kamera Lensi", type: "rare", baseValue: 7000 },
            { name: "El Dokumasƒ± Kilim", type: "rare", baseValue: 6000 },
            { name: "ƒ∞lk Basƒ±m √áizgi Roman", type: "rare", baseValue: 5500 },
            { name: "Mekanik Daktilo", type: "rare", baseValue: 7500 },
            { name: "Bakƒ±r ƒ∞mbik", type: "rare", baseValue: 6000 },
            { name: "Koleksiyonluk Plak (Barƒ±≈ü Man√ßo)", type: "rare", baseValue: 9000 },
            { name: "Profesyonel Teleskop", type: "rare", baseValue: 8500 },
            { name: "Eski Marka √áakmak (G√ºm√º≈ü)", type: "rare", baseValue: 5200 },
            { name: "Deri Kovboy √áizmeleri", type: "rare", baseValue: 4500 },
            { name: "Oyuncu Bilgisayarƒ± Kasasƒ±", type: "rare", baseValue: 9800 },

            // LEGENDARY
            { name: "Osmanlƒ± D√∂nemi Han√ßer", type: "legendary", baseValue: 35000 },
            { name: "Altƒ±n Kolye (18 Ayar)", type: "legendary", baseValue: 28000 },
            { name: "Kapalƒ± Kutu Son Model Laptop", type: "legendary", baseValue: 45000 },
            { name: "√únl√º Bir Ressamƒ±n Eskizi", type: "legendary", baseValue: 60000 },
            { name: "Elmas Y√ºz√ºk", type: "legendary", baseValue: 80000 },
            { name: "Meteor Par√ßasƒ±", type: "legendary", baseValue: 40000 },
            { name: "ƒ∞mzalƒ± Atat√ºrk Portresi (Orijinal)", type: "legendary", baseValue: 95000 },
            { name: "Kapalƒ± Kutu Retro Konsol (1985)", type: "legendary", baseValue: 55000 },
            { name: "Viking D√∂nemi Balta Ucu", type: "legendary", baseValue: 70000 },
            { name: "Kripto C√ºzdan (≈ûifresi √úst√ºnde)", type: "legendary", baseValue: 120000 },
            { name: "Safir Ta≈ülƒ± Bro≈ü", type: "legendary", baseValue: 65000 }
        ];

        // --- OPPONENTS ---
        const OPPONENTS = [
            { id: 'yilong', name: 'Yilong Ma', avatar: 'üöÄ', wealth: 999999, aggressive: 0.9, patience: 2, desc: 'Teknoloji Milyarderi' },
            { id: 'hasan', name: 'Hurdacƒ± Hasan', avatar: 'üß¢', wealth: 5000, aggressive: 0.3, patience: 5, desc: 'Eski Toprak' },
            { id: 'daniel', name: 'Jew Daniel', avatar: 'üíé', wealth: 50000, aggressive: 0.7, patience: 4, desc: 'Kuyumcu' },
            { id: 'cilem', name: 'Bitmeyen √áilem', avatar: 'üö¨', wealth: 2000, aggressive: 0.1, patience: 1, desc: '≈ûanssƒ±z' }
        ];

        const OPPONENT_LINES = {
            yilong: {
                bid: [
                    "To the moon! üöÄ",
                    "ËøôÊòØÊàëÁöÑ!",  // (This is mine!)
                    "Buying this for Mars colony.",
                    "ÊàëË¶ÅËøô‰∏™!",  // (I want this!)
                    "Paying with Doge.",
                    "Technology is the future!",
                    "Â§™Â•Ω‰∫Ü!"     // (Great!)
                ],
                fold: [
                    "‰∏ç!",        // (No!)
                    "Boring.",
                    "Paper hands...",
                    "Ê≤°ÊúâÊÑèÊÄù.",   // (Boring/Not interesting)
                    "Waiting for the dip."
                ],
                random: [
                    "‰Ω†Â•ΩÂêó?",     // (How are you?)
                    "When Lambo?",
                    "My rocket is ready.",
                    "Êàë‰ª¨ÂéªÁÅ´Êòü!", // (Let's go to Mars!)
                    "420.69 is the magic number."
                ]
            },
            hasan: {
                bid: [
                    "Paslƒ± maslƒ± ama i≈ü g√∂r√ºr.",
                    "Hurdasƒ± para eder bunun.",
                    "Atƒ±n √∂l√ºm√º arpadan olsun.",
                    "Aman, demiri iyi duruyor.",
                    "√ú√ß be≈ü bir ≈üey ate≈üleriz."
                ],
                fold: [
                    "O paraya kamyon alƒ±rƒ±m be!",
                    "Soygun var polis!",
                    "Hadi ordan, teneke bu.",
                    "Kurtarmaz yeƒüenim, kurtarmaz.",
                    "Bu fiyata hurda alƒ±nmaz."
                ],
                random: [
                    "Eskiciiiii!",
                    "Demir fiyatlarƒ± d√º≈üt√º m√º?",
                    "√áay s√∂yleyin de i√ßelim.",
                    "Bizim oƒülanƒ± sanayiye verdim.",
                    "Eski devir kalmadƒ± azizim."
                ]
            },
            daniel: {
                bid: [
                    "A fair price... barely.",
                    "I smell a profit margin here.",
                    "Mazel tov! I'm in.",
                    "With a little polish, I can flip this.",
                    "Such a deal, I'd be meshuga to pass.",
                    "Good business is where you find it."
                ],
                fold: [
                    "Oy vey! Look at that price!",
                    "You are robbing me blind!",
                    "Where is the profit? Nowhere!",
                    "Too rich for my blood.",
                    "Such chutzpah asking for this much!",
                    "I'm out. My mother raised no fool."
                ],
                random: [
                    "Time is money, friend.",
                    "You call this a storage unit?",
                    "I know a guy who knows a guy...",
                    "Buy wholesale, sell retail. Simple.",
                    "Nu? Are we bidding or staring?"
                ]
            },
            cilem: {
                bid: [
                    "√áoluk √ßocuƒüun rƒ±zkƒ±nƒ± basƒ±yorum...",
                    "Ah, yine pi≈üman olacaƒüƒ±m.",
                    "Son kuru≈üumla...",
                    "Belki bu sefer y√ºz√ºm g√ºler?",
                    "Buna da girelim bakalƒ±m, ne √ßƒ±karsa..."
                ],
                fold: [
                    "Biliyordum... Hep b√∂yle olur.",
                    "Zaten ≈üansƒ±m yok.",
                    "Kaderimse √ßekerim.",
                    "Bu d√ºnya bana dar.",
                    "Yine kaybettim, alƒ±≈üƒ±ƒüƒ±m.",
                    "Param yetmez ki..."
                ],
                random: [
                    "Ba≈üƒ±ma giren aƒürƒ±lar...",
                    "Kesin bo≈ü √ßƒ±kacak, hissediyorum.",
                    "Neden doƒüdum ki?",
                    "Ak≈üam eve ne g√∂t√ºreceƒüim?",
                    "Off off... Y√ºz√ºm√ºz g√ºlmedi."
                ]
            }
        };

        // --- SKILLS CONFIGURATION ---
        const SKILLS_CONFIG = {
            xray: {
                id: 'xray',
                name: 'R√∂ntgen G√∂zler',
                maxLevel: 3,
                cost: 1,
                desc: 'Kutularƒ±n riskini daha iyi analiz etme ≈üansƒ± saƒülar.'
            },
            silverTongue: {
                id: 'silverTongue',
                name: 'Tatlƒ± Dil',
                maxLevel: 3,
                cost: 1,
                desc: 'Pazarlƒ±kta EO\'nun sabrƒ±nƒ± daha az t√ºketirsin.'
            },
            restorer: {
                id: 'restorer',
                name: 'Usta Tamirci',
                maxLevel: 5,
                cost: 1,
                desc: 'At√∂lyede hurda e≈üyalarƒ± onarma ≈üansƒ±nƒ± artƒ±rƒ±r.'
            },
            hoarder: {
                id: 'hoarder',
                name: 'ƒ∞stif√ßi',
                maxLevel: 5,
                cost: 1,
                desc: 'Depo kapasitesini kalƒ±cƒ± olarak +5 artƒ±rƒ±r.'
            }
        };

        // --- EO INTELLIGENCE ---
        const EO_AI = {
            mood: 'neutral', // neutral, happy, annoyed, angry
            patience: 3, // Lowers with bad offers

            dialogue: {
                greeting: {
                    friendly: [
                        "Ooo, benim favori t√ºccarƒ±m gelmi≈ü! Yine mi beni batƒ±rmaya √ßalƒ±≈üacaksƒ±n, yoksa bu sefer ger√ßekten i≈üe yarar bir ≈üeyin var mƒ±?",
                        "Ho≈ü geldin dostum! Bakalƒ±m bug√ºn hangi '≈üahane' mallarƒ± itelemeye √ßalƒ±≈üacaksƒ±n?",
                        "G√∂z√ºm yollarda kaldƒ±. Hadi g√∂ster bakalƒ±m, bug√ºn beni nasƒ±l kandƒ±racaksƒ±n?"
                    ],
                    neutral: [
                        "Ho≈ü geldin. Bakalƒ±m bug√ºn ne getirdin.",
                        "Umarƒ±m vakit harcamaya deƒüecek ≈üeyler vardƒ±r.",
                        "D√ºkkan a√ßƒ±k, ama sabrƒ±m sƒ±nƒ±rlƒ±. G√∂ster bakalƒ±m."
                    ],
                    suspicious: [
                        "Yine mi sen? √áabuk ol, fazla vaktim yok.",
                        "Sadece bakƒ±yorum, s√∂z vermem. ≈û√ºpheli bir ≈üey g√∂r√ºrsem polisi ararƒ±m.",
                        "Kapƒ±dan girmeden √∂nce ayakkabƒ±larƒ±nƒ± sildin mi? Ne istiyorsun?"
                    ]
                },
                inspecting: {
                    friendly: [
                        "Bakalƒ±m bug√ºn hangi hazineyi buldun?",
                        "Bunu benim i√ßin mi sakladƒ±n? Hadi g√∂relim.",
                        "G√ºzel bir ≈üeye benziyor, anlat bakalƒ±m."
                    ],
                    neutral: [
                        "Hƒ±mm... ≈ûuna bir bakalƒ±m.",
                        "Bunun ne olduƒüunu bildiƒüine emin misin?",
                        "ƒ∞lgin√ß... ama satƒ±lƒ±r mƒ± emin deƒüilim."
                    ],
                    suspicious: [
                        "Ceplerini bo≈üalt. Bu ne?",
                        "√áalƒ±ntƒ± mal almƒ±yorum, ba≈ütan s√∂yleyeyim.",
                        "Hƒ±zlƒ± ol, buna deƒüer mi?"
                    ]
                },
                lowball: {
                    friendly: [
                        "Yapma ≈üimdi, dostuz diye kazƒ±klayacak mƒ±sƒ±n beni?",
                        "Seni severim ama c√ºzdanƒ±mƒ± daha √ßok severim. Fiyat bu.",
                        "Hadi ama, bu fiyata bana ver, hatƒ±rƒ±m kalƒ±r."
                    ],
                    neutral: [
                        "Buna en fazla bu kadar veririm. ƒ∞≈üine gelirse.",
                        "Bak, bu piyasada bundan fazlasƒ±nƒ± bulamazsƒ±n.",
                        "Piyasa durgun, teklifim bu."
                    ],
                    suspicious: [
                        "Bu hurdaya bu fiyat √ßok bile. Al ya da git.",
                        "Bunu ba≈ükasƒ±na satamazsƒ±n, dua et ben alƒ±yorum.",
                        "Sana bir iyilik yapƒ±p bu parayƒ± veriyorum, uzatma."
                    ]
                },
                accept: {
                    friendly: [
                        "Hah ≈ü√∂yle! Seninle i≈ü yapmayƒ± bu y√ºzden seviyorum.",
                        "G√ºzel anla≈üma. Bir kahve de ƒ±smarlayayƒ±m mƒ±? ≈ûaka ≈üaka, git hadi.",
                        "Tamamdƒ±r dostum, hayrƒ±nƒ± g√∂r."
                    ],
                    neutral: [
                        "Tamamdƒ±r, anla≈ütƒ±k.",
                        "Makul. Al paranƒ±.",
                        "G√ºzel, ver bakalƒ±m."
                    ],
                    suspicious: [
                        "Al paranƒ± ve kaybol.",
                        "Sonunda. Bir daha b√∂yle pazarlƒ±k yapma.",
                        "Tamam, ≈üimdi git d√ºkkanƒ±mdan."
                    ]
                },
                reject: {
                    friendly: [
                        "≈ûakacƒ± seni! Ama cidden, olmaz.",
                        "Beni g√ºld√ºrd√ºn, ama o fiyata imkansƒ±z dostum.",
                        "Yok artƒ±k, o fiyata d√ºkkanƒ± da vereyim mi?"
                    ],
                    neutral: [
                        "Dalga mƒ± ge√ßiyorsun? Git i≈üine.",
                        "Bu fiyatla ancak kendini kandƒ±rƒ±rsƒ±n.",
                        "Benimle oyun oynama evlat."
                    ],
                    suspicious: [
                        "√áƒ±k dƒ±≈üarƒ±! Hemen!",
                        "Seni ciddiye alanda kabahat. Defol.",
                        "Sabrƒ±mƒ± zorluyorsun yabancƒ±."
                    ]
                },
                threatResponse: [
                    "Beni tehdit etme, zararlƒ± √ßƒ±karsƒ±n.",
                    "Cesaretini takdir ettim ama aptallƒ±ƒüƒ±nƒ± deƒüil.",
                    "Tamam tamam, sakin ol. Belki bir ≈üeyler yapabiliriz."
                ],
                consulting_start: {
                    friendly: [
                        "Senden bu kadar kaliteli bir ≈üey √ßƒ±kmaz ama, neyse... Gidip bir ${itemName} uzmanƒ±ma danƒ±≈üƒ±p geleyim.",
                        "Tipine bakƒ±nca dolandƒ±rƒ±cƒ± gibisin ama mal ger√ßek gibi. Dur bi ${itemName} uzmanƒ±ma danƒ±≈üƒ±p geleyim.",
                        "Bunu √ß√∂pten bulmadƒ±ƒüƒ±na emin misin? Bekle, ${itemName} uzmanƒ±ma danƒ±≈üƒ±p geleyim."
                    ],
                    neutral: [
                        "Bunu bir ${itemName} uzmanƒ±ma danƒ±≈üƒ±p geleyim. Bekle burada.",
                        "Bir dakka, ≈üunu hemen ${itemName} uzmanƒ±ma danƒ±≈üƒ±p geliyorum.",
                        "Bekle biraz, ≈üunu bi ${itemName} uzmanƒ±ma danƒ±≈üƒ±p geleyim."
                    ],
                    suspicious: [
                        "G√∂z√ºm seni hi√ß tutmadƒ±. Bu ${itemName} uzmanƒ±ma g√∂stermeden almam.",
                        "Eƒüer sahteyse ba≈üƒ±n derde girer. Gidip ${itemName} uzmanƒ±ma danƒ±≈üƒ±p geleyim.",
                        "Malƒ±na g√ºvenmiyorum, sana hi√ß g√ºvenmiyorum. Mecburen ${itemName} uzmanƒ±ma danƒ±≈üƒ±p geleyim."
                    ]
                },
                consulting_end: {
                    friendly: [
                        "Arkada≈üƒ±m baktƒ±, sorun yokmu≈ü. ≈ûa≈üƒ±rtƒ±cƒ±... Hadi fiyatƒ± konu≈üalƒ±m.",
                        "Tamamdƒ±r, onay verdi. Hadi yine iyisin."
                    ],
                    neutral: [
                        "Uzmanƒ±m inceledi. Tamamdƒ±r, pazarlƒ±ƒüa ge√ßelim.",
                        "Geldim. Uzmanƒ±mla konu≈ütum, bir sƒ±kƒ±ntƒ± yok."
                    ],
                    suspicious: [
                        "Uzmanƒ±m ger√ßek dedi ama benim hala ≈ü√ºphelerim var. Neyse.",
                        "≈ûimdilik inandƒ±m say. Ama g√∂z√ºm √ºzerinde."
                    ]
                }
            },

            getLine: function(category, reputation) {
                // If the category is threatResponse (array), return directly
                if (Array.isArray(this.dialogue[category])) {
                    const lines = this.dialogue[category];
                    return lines[Math.floor(Math.random() * lines.length)];
                }

                let tier = 'neutral';
                if (reputation > 70) tier = 'friendly';
                else if (reputation < 30) tier = 'suspicious';

                const lines = this.dialogue[category][tier];
                return lines[Math.floor(Math.random() * lines.length)];
            },

            // Logic to determine initial offer (always lowball)
            calculateOffer: function(itemRealValue, reputation) {
                // Base offer is 40-60% of real value
                let percent = 0.4 + (Math.random() * 0.2);

                // Reputation bonus
                if (reputation > 70) percent += 0.15; // Better offers for friends
                if (reputation < 30) percent -= 0.15; // Worse for suspicious

                return Math.floor(itemRealValue * percent);
            }
        };

        // --- STATE ---
        let gameState = {
            money: GAME_CONFIG.startMoney,
            round: 1,
            reputation: 50, // 0-100, 50 is neutral
            inventory: [],
            currentUnit: null,
            history: [],
            gameOver: false,
            eoPatience: 4, // Max 4 per round
            negotiationMemory: {}, // Remembers offers per item
            auction: null, // Active auction state
            // NEW FIELDS
            xp: 0,
            level: 1,
            skillPoints: 0,
            skills: {
                xray: 0,
                silverTongue: 0,
                restorer: 0,
                hoarder: 0
            },
            quests: [], // Active quests
            inventoryLimit: 10,
            storageLevel: 1
        };

        // --- DOM ELEMENTS ---
        const ui = {
            app: document.getElementById('app'),
            money: document.getElementById('ui-money'),
            round: document.getElementById('ui-round'),
            rep: document.getElementById('ui-reputation')
        };

        // --- INIT ---
        window.onload = () => {
            initGame();
        };

        function initGame() {
            console.log("Oyun Ba≈ülatƒ±ldƒ±.");
            updateHeader();
            startRound();
        }

        function updateHeader() {
            ui.money.innerText = gameState.money.toLocaleString('tr-TR') + ' ‚Ç∫';
            ui.round.innerText = gameState.round;

            let repText = "N√∂tr";
            if (gameState.reputation > 70) repText = "Dost";
            else if (gameState.reputation > 85) repText = "Ortak";
            else if (gameState.reputation < 30) repText = "≈û√ºpheli";
            else if (gameState.reputation < 15) repText = "D√º≈üman";

            ui.rep.innerText = repText;
            ui.rep.style.color = gameState.reputation < 30 ? 'var(--danger-color)' : (gameState.reputation > 70 ? 'var(--success-color)' : 'var(--text-color)');
        }

        // --- GAME LOGIC ---

        // XP SYSTEM
        function addXp(amount) {
            gameState.xp += amount;
            const xpNeeded = gameState.level * 1000;
            if (gameState.xp >= xpNeeded) {
                gameState.level++;
                gameState.xp -= xpNeeded;
                gameState.skillPoints++;
                alert(`üéâ TEBRƒ∞KLER! Seviye Atladƒ±n! Yeni Seviye: ${gameState.level}. +1 Yetenek Puanƒ± kazandƒ±n.`);
            }
            updateHeader();
        }

        // QUEST SYSTEM
        function generateQuests() {
            gameState.quests = [];
            const questCount = 2 + Math.floor(Math.random() * 2); // 2 or 3
            const categories = ["Elektronik", "Antika", "Giyim", "Mobilya", "Spor"];

            for(let i=0; i<questCount; i++) {
                const isSellQuest = Math.random() > 0.5;
                if (isSellQuest) {
                    const type = Math.random() > 0.7 ? 'rare' : 'common';
                    const targetCount = 1 + Math.floor(Math.random() * 2);
                    const rewardMult = type === 'rare' ? 2 : 1;
                    gameState.quests.push({
                        id: Date.now() + i,
                        text: `${targetCount} adet ${type === 'rare' ? 'Nadir' : 'Sƒ±radan'} e≈üya sat`,
                        type: 'sell_rarity',
                        target: type,
                        count: targetCount,
                        current: 0,
                        rewardMoney: 500 * targetCount * rewardMult,
                        rewardXp: 100 * targetCount * rewardMult
                    });
                } else {
                    const cat = categories[Math.floor(Math.random() * categories.length)];
                    const targetCount = 1 + Math.floor(Math.random() * 2);
                    gameState.quests.push({
                        id: Date.now() + i,
                        text: `${targetCount} adet ${cat} kategorisinde e≈üya sat`,
                        type: 'sell_category',
                        target: cat,
                        count: targetCount,
                        current: 0,
                        rewardMoney: 400 * targetCount,
                        rewardXp: 80 * targetCount
                    });
                }
            }
        }

        function checkQuestProgress(item) {
            let completedAny = false;
            gameState.quests.forEach(q => {
                if (q.completed) return;

                let match = false;
                if (q.type === 'sell_rarity' && item.type === q.target) match = true;
                if (q.type === 'sell_category' && item.category === q.target) match = true;

                if (match) {
                    q.current++;
                    if (q.current >= q.count) {
                        q.completed = true;
                        gameState.money += q.rewardMoney;
                        addXp(q.rewardXp);
                        alert(`‚úÖ G√ñREV TAMAMLANDI: ${q.text}\n√ñd√ºl: ${q.rewardMoney}‚Ç∫, ${q.rewardXp} XP`);
                        completedAny = true;
                    }
                }
            });
            if(completedAny) updateHeader();
        }

        function startRound() {
            gameState.availableUnits = generateStorageUnits();
            generateQuests(); // New quests every round

            // Determine Patience based on Reputation
            if (gameState.reputation > 70) gameState.eoPatience = 4;
            else if (gameState.reputation < 30) gameState.eoPatience = 2;
            else gameState.eoPatience = 3;

            gameState.negotiationMemory = {};

            // Check for Game Over (Bankruptcy)
            // If the player cannot afford the cheapest unit, they are done.
            const cheapestUnit = Math.min(...gameState.availableUnits.map(u => u.price));

            if (gameState.money < cheapestUnit) {
                renderGameOver();
            } else {
                renderStorageSelection();
            }
        }

        function renderGameOver() {
            ui.app.innerHTML = `
                <div class="screen screen-glass">
                    <h1 style="color: var(--danger-color)">üö´ ƒ∞FLAS ETTƒ∞N</h1>
                    <div style="font-size:3rem; margin:20px;">üí∏</div>
                    <p>Cebinde kalan para: <span class="money">${gameState.money} ‚Ç∫</span></p>
                    <div class="speech-bubble" style="margin:20px auto; color:#333;">EO: "√úzg√ºn√ºm dostum, burasƒ± hayƒ±r kurumu deƒüil. Ba≈üka kapƒ±ya."</div>
                    <p>Ula≈üƒ±lan Tur: ${gameState.round}</p>
                    <button class="btn" onclick="location.reload()">üîÑ TEKRAR DENE</button>
                </div>
            `;
        }

        function generateStorageUnits() {
            const units = [];
            const risks = ['D√º≈ü√ºk', 'Orta', 'Y√ºksek'];

            for(let i=0; i<5; i++) {
                // Black Market Chance (3%)
                let isBlackMarket = Math.random() < 0.03;

                let riskLevel, riskLabel, name, desc, className;
                let estimatedMin, estimatedMax;

                if (isBlackMarket) {
                    riskLevel = 3; // Special ID for Black Market
                    riskLabel = "KARA BORSA";
                    name = `Depo #${100 + i + (gameState.round * 5)} (KARA BORSA)`;
                    className = "black-market";
                    desc = "Kƒ±rmƒ±zƒ± bir ƒ±≈üƒ±k yayƒ±yor... ƒ∞√ßerisi tehlikeli g√∂r√ºn√ºyor.";

                    let baseVal = 15000 + (gameState.round * 2000);
                    // Black market estimate is always huge range
                    estimatedMin = Math.floor(baseVal * 0.5);
                    estimatedMax = Math.floor(baseVal * 3.0);

                } else {
                    riskLevel = Math.floor(Math.random() * 3); // 0, 1, 2
                    riskLabel = risks[riskLevel];
                    name = `Depo #${100 + i + (gameState.round * 5)}`;
                    className = "";
                    desc = generateUnitDescription(riskLevel);

                    let baseVal = 500 + (gameState.round * 50);
                    if(riskLevel === 1) baseVal *= 1.5;
                    if(riskLevel === 2) baseVal *= 2.5;

                    // Accuracy Logic
                    if (riskLevel === 0) { // Low Risk: Accurate
                        estimatedMin = Math.floor(baseVal * 0.9);
                        estimatedMax = Math.floor(baseVal * 1.1);
                    } else if (riskLevel === 1) { // Med Risk: Balanced
                        estimatedMin = Math.floor(baseVal * 0.7);
                        estimatedMax = Math.floor(baseVal * 1.4);
                    } else { // High Risk: Wild
                        estimatedMin = Math.floor(baseVal * 0.4);
                        estimatedMax = Math.floor(baseVal * 2.5);
                    }
                }

                units.push({
                    id: i,
                    name: name,
                    risk: riskLevel,
                    riskLabel: riskLabel,
                    estimatedMin: estimatedMin,
                    estimatedMax: estimatedMax,
                    description: desc,
                    className: className,
                    soldTo: null // Tracks if AI bought it
                });
            }
            return units;
        }

        function generateUnitDescription(risk) {
            const descs = [
                ["Temiz g√∂r√ºn√ºyor.", "Birka√ß koli var.", "Standart ev e≈üyalarƒ±."], // Low
                ["Karƒ±≈üƒ±k bir yƒ±ƒüƒ±n.", "Bazƒ± kutular kapalƒ±.", "Tozlu ama dolu."], // Med
                ["Tam bir muamma.", "Ya hazine ya √ß√∂p.", "Aƒüƒ±r kutular var."] // High
            ];
            return descs[risk][Math.floor(Math.random() * descs[risk].length)];
        }

        // --- AUCTION SYSTEM ---

        window.startAuction = function(unitId) {
            const unit = gameState.availableUnits.find(u => u.id === unitId);
            if (!unit) return;

            // Initialize Auction State
            const startBid = Math.floor((unit.estimatedMin + unit.estimatedMax) / 2 * 0.5);

            gameState.auction = {
                unit: unit,
                currentBid: startBid,
                highestBidder: null, // null = no one yet (or house)
                timer: 0, // 0=Waiting, 1=Going Once, 2=Going Twice, 3=Sold
                timerInterval: null,
                participants: OPPONENTS.map(op => ({
                    ...op,
                    isFolded: false,
                    lastAction: null // 'bid', 'pass', 'wait'
                })),
                log: [`ƒ∞hale ba≈üladƒ±! Ba≈ülangƒ±√ß fiyatƒ±: ${startBid} ‚Ç∫`],
                playerFolded: false,
                lastBidTime: Date.now(),
                lastLogIndex: 0
            };

            setupAuctionUI();

            // Start the loop
            if (gameState.auction.timerInterval) clearInterval(gameState.auction.timerInterval);
            gameState.auction.timerInterval = setInterval(updateAuctionLoop, 1000);
        };

        function setupAuctionUI() {
            const auc = gameState.auction;
            const unit = auc.unit;

            // Participants HTML
            const opponentsHtml = auc.participants.map(p => {
                return `
                <div id="opponent-card-${p.id}" class="opponent-card">
                    <div class="opponent-avatar">${p.avatar}</div>
                    <div class="opponent-name">${p.name}</div>
                    <div id="leader-badge-${p.id}" style="font-size:0.7rem; color:var(--success-color); font-weight:bold; display:none;">Lƒ∞DER</div>
                </div>
                `;
            }).join('');

            ui.app.innerHTML = `
                <div class="screen screen-glass" style="max-width:1000px">
                    <div class="auction-header">
                        <div>
                            <h2 style="margin:0">${unit.name}</h2>
                            <div style="font-size:0.9rem; opacity:0.7">Tahmini: ${unit.estimatedMin} - ${unit.estimatedMax} ‚Ç∫</div>
                        </div>
                        <div class="money">${gameState.money} ‚Ç∫</div>
                    </div>

                    <div class="auction-main">
                        <div class="auction-visual">
                            <div style="font-size:1.2rem; color:#aaa; margin-bottom:10px;">G√úNCEL TEKLƒ∞F</div>
                            <div id="auction-current-bid" class="current-bid-display">${auc.currentBid} ‚Ç∫</div>
                            <div id="auction-timer-text" class="timer-display">Teklif Bekleniyor...</div>
                            <div id="player-win-msg" style="color:var(--success-color); font-weight:bold; margin-top:10px; display:none;">üèÜ ≈ûU AN KAZANIYORSUN!</div>
                        </div>

                        <div class="opponents-grid">
                            ${opponentsHtml}
                            <!-- Player Card -->
                            <div id="opponent-card-player" class="opponent-card">
                                <div class="opponent-avatar">üë§</div>
                                <div class="opponent-name">SEN</div>
                                <div id="leader-badge-player" style="font-size:0.7rem; color:var(--success-color); font-weight:bold; display:none;">Lƒ∞DER</div>
                            </div>
                        </div>

                        <div class="bid-log" id="auction-log">
                            <div class="log-entry">${auc.log[0]}</div>
                        </div>

                        <div class="player-controls">
                            <button id="btn-bid-50" class="btn" onclick="placePlayerBid(50)">+50 ‚Ç∫</button>
                            <button id="btn-bid-200" class="btn" onclick="placePlayerBid(200)">+200 ‚Ç∫</button>
                            <button id="btn-fold" class="btn btn-danger" onclick="playerFold()">√áEKƒ∞L üè≥Ô∏è</button>
                        </div>
                    </div>
                </div>
            `;

            // Set initial lastLogIndex
            auc.lastLogIndex = 1;
        }

        function updateAuctionUI() {
            const auc = gameState.auction;
            if(!auc) return;

            // Update Bid Text
            document.getElementById('auction-current-bid').innerText = auc.currentBid + ' ‚Ç∫';

            // Update Timer Text
            let timerText = "Teklif Bekleniyor...";
            if (auc.timer === 1) timerText = "SATILIYOR... (1)";
            if (auc.timer === 2) timerText = "SATILIYOR... (2)";
            if (auc.timer === 3) timerText = "SATILDI!";
            document.getElementById('auction-timer-text').innerText = timerText;

            // Update Participants Visuals
            auc.participants.forEach(p => {
                const card = document.getElementById(`opponent-card-${p.id}`);
                const badge = document.getElementById(`leader-badge-${p.id}`);

                if (card) {
                    // Classes
                    if (p.isFolded) {
                        card.classList.add('folded');
                        card.classList.remove('active-bidder');
                    } else if (auc.highestBidder && auc.highestBidder.id === p.id) {
                        card.classList.add('active-bidder');
                        card.classList.remove('folded');
                    } else {
                        card.classList.remove('active-bidder', 'folded');
                    }
                }

                if (badge) {
                    badge.style.display = (auc.highestBidder && auc.highestBidder.id === p.id) ? 'block' : 'none';
                }
            });

            // Update Player Visuals
            const pCard = document.getElementById('opponent-card-player');
            const pBadge = document.getElementById('leader-badge-player');
            const pWinMsg = document.getElementById('player-win-msg');
            const isPlayerLeader = auc.highestBidder && auc.highestBidder.id === 'player';

            if (pCard) {
                if (auc.playerFolded) {
                    pCard.classList.add('folded');
                    pCard.classList.remove('active-bidder');
                } else if (isPlayerLeader) {
                    pCard.classList.add('active-bidder');
                    pCard.classList.remove('folded');
                } else {
                    pCard.classList.remove('active-bidder', 'folded');
                }
            }

            if (pBadge) pBadge.style.display = isPlayerLeader ? 'block' : 'none';
            if (pWinMsg) pWinMsg.style.display = isPlayerLeader ? 'block' : 'none';

            // Update Buttons
            const canBid = !auc.playerFolded && gameState.money >= (auc.currentBid + 50) && auc.timer < 3;
            document.getElementById('btn-bid-50').disabled = !canBid;
            document.getElementById('btn-bid-200').disabled = !canBid;
            document.getElementById('btn-fold').disabled = (auc.playerFolded || auc.timer >= 3);

            // Update Log (Append only)
            const logContainer = document.getElementById('auction-log');
            if (logContainer && auc.lastLogIndex < auc.log.length) {
                for (let i = auc.lastLogIndex; i < auc.log.length; i++) {
                    const entry = auc.log[i];
                    const isHigh = entry.includes('teklif');
                    const isFold = entry.includes('√ßekildi');
                    const className = isHigh ? 'high-bid' : (isFold ? 'fold' : '');

                    const div = document.createElement('div');
                    div.className = `log-entry ${className}`;
                    div.innerText = entry;
                    logContainer.appendChild(div);
                }
                auc.lastLogIndex = auc.log.length;
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        function showSpeech(id, type) {
            const linesObj = OPPONENT_LINES[id];
            if (!linesObj) return;

            const lines = linesObj[type];
            if (!lines || lines.length === 0) return;

            const text = lines[Math.floor(Math.random() * lines.length)];

            const card = document.getElementById(`opponent-card-${id}`);
            if (!card) return;

            // Remove existing bubble if any
            const existing = card.querySelector('.mini-bubble');
            if (existing) existing.remove();

            const bubble = document.createElement('div');
            bubble.className = 'mini-bubble';
            bubble.innerText = text;

            card.appendChild(bubble);

            setTimeout(() => {
                bubble.style.opacity = '0';
                setTimeout(() => bubble.remove(), 300);
            }, 3000);
        }

        window.placePlayerBid = function(amount) {
            const auc = gameState.auction;
            if(!auc || auc.playerFolded) return;

            const nextBid = auc.currentBid + amount;
            if(gameState.money < nextBid) {
                alert("Yetersiz bakiye!");
                return;
            }

            placeBid('player', nextBid);
        };

        window.playerFold = function() {
            const auc = gameState.auction;
            if(!auc) return;

            auc.playerFolded = true;
            auc.log.push(`üè≥Ô∏è Sen ihaleden √ßekildin.`);
            updateAuctionUI();
        };

        function updateAuctionLoop() {
            const auc = gameState.auction;
            if(!auc) return;

            // Timer Logic
            const now = Date.now();
            const timeSinceLastBid = now - auc.lastBidTime;

            if (timeSinceLastBid > 9000) {
                auc.timer = 3; // SOLD
                updateAuctionUI(); // Final update
                clearInterval(auc.timerInterval);
                setTimeout(endAuction, 500); // Small delay to see SOLD state
            } else if (timeSinceLastBid > 6000) {
                auc.timer = 2; // Going Twice
            } else if (timeSinceLastBid > 3000) {
                auc.timer = 1; // Going Once
            } else {
                auc.timer = 0; // Waiting
            }

            // Random Speech Chance (Idle)
            if (Math.random() < 0.05) { // 5% per second
                const active = auc.participants.filter(p => !p.isFolded);
                if (active.length > 0) {
                    const speaker = active[Math.floor(Math.random() * active.length)];
                    showSpeech(speaker.id, 'random');
                }
            }

            // Process AI (if not sold)
            if (auc.timer < 3) {
                 processAIBidding();
            }

            updateAuctionUI();
        }

        function processAIBidding() {
            const auc = gameState.auction;
            // Only one AI bids per tick max to avoid chaos, or random chance
            if (Math.random() < 0.6) return; // 60% chance no one acts this tick

            // Shuffle participants to randomise order
            const activeAI = auc.participants.filter(p => !p.isFolded && p.id !== (auc.highestBidder ? auc.highestBidder.id : ''));
            if (activeAI.length === 0) return;

            const ai = activeAI[Math.floor(Math.random() * activeAI.length)];

            // Decision Logic
            const unit = auc.unit;

            if (!ai.perceivedLimit) {
                // Initialize limit once
                let estimateAvg = (unit.estimatedMin + unit.estimatedMax) / 2;
                let riskFactor = 1;
                if (unit.risk === 1) riskFactor = 1.2;
                if (unit.risk === 2) riskFactor = 1.5;
                if (unit.risk === 3) riskFactor = 2.0; // Black market

                switch(ai.id) {
                    case 'yilong': // Crazy, rich, troll
                        ai.perceivedLimit = unit.estimatedMax * (1 + Math.random() * 2);
                        break;
                    case 'hasan': // Scrap dealer, very conservative
                        ai.perceivedLimit = unit.estimatedMin * (0.8 + Math.random() * 0.3);
                        break;
                    case 'daniel': // Smart, calculates margin
                        ai.perceivedLimit = unit.estimatedMax * 0.8;
                        break;
                    case 'cilem': // Pessimist, poor
                        ai.perceivedLimit = unit.estimatedMin * (0.5 + Math.random() * 0.4);
                        break;
                }
            }

            // Logic to Bid or Fold
            const nextMinBid = auc.currentBid + 50;

            // Check budget
            if (nextMinBid > ai.wealth) {
                ai.isFolded = true;
                auc.log.push(`${ai.avatar} ${ai.name} parasƒ±zlƒ±ktan √ßekildi.`);
                showSpeech(ai.id, 'fold');
                return;
            }

            // Check Limit
            if (nextMinBid > ai.perceivedLimit) {
                // Yilong might troll and go over limit sometimes (10%)
                if (ai.id === 'yilong' && Math.random() < 0.1) {
                     // Troll bid
                } else {
                    ai.isFolded = true;
                    auc.log.push(`${ai.avatar} ${ai.name} √ßekildi.`);
                    showSpeech(ai.id, 'fold');
                    return;
                }
            }

            // Yilong "Wait" Logic
            if (ai.id === 'yilong' && Math.random() < 0.3) {
                return;
            }

            // Place Bid
            let increment = 50;
            if (ai.aggressive > 0.5 && Math.random() < 0.5) increment = 200;
            if (ai.id === 'yilong' && Math.random() < 0.2) increment = 500;

            placeBid(ai.id, auc.currentBid + increment);
        }

        function placeBid(bidderId, amount) {
            const auc = gameState.auction;
            if(auc.timer >= 3) return; // Closed

            // Update State
            auc.currentBid = amount;

            if (bidderId === 'player') {
                auc.highestBidder = { id: 'player', name: 'SEN' };
                auc.log.push(`üë§ SEN ${amount} ‚Ç∫ teklif verdin!`);
            } else {
                const ai = auc.participants.find(p => p.id === bidderId);
                auc.highestBidder = ai;
                auc.log.push(`${ai.avatar} ${ai.name} ${amount} ‚Ç∫ teklif verdi!`);

                showSpeech(ai.id, 'bid');
            }

            // Reset Timer
            auc.lastBidTime = Date.now();
            auc.timer = 0;

            // Immediate UI update for responsiveness
            updateAuctionUI();
        }

        function endAuction() {
            const auc = gameState.auction;
            const winner = auc.highestBidder;

            if (winner && winner.id === 'player') {
                // Player Won
                if (gameState.money >= auc.currentBid) {
                    completePlayerPurchase(auc.unit, auc.currentBid);
                } else {
                    alert("Hata: Yetersiz Bakiye!");
                    renderStorageSelection();
                }
            } else if (winner) {
                // AI Won
                alert(`ƒ∞haleyi ${winner.name} kazandƒ±! Fiyat: ${auc.currentBid} ‚Ç∫`);
                auc.unit.soldTo = winner;
                renderStorageSelection();
            } else {
                alert("Kimse teklif vermedi. ƒ∞hale iptal.");
                renderStorageSelection();
            }
            gameState.auction = null;
        }

        function completePlayerPurchase(unit, finalPrice) {
            gameState.money -= finalPrice;
            gameState.currentUnit = unit;
            updateHeader();

            // Generate items
            const newItems = generateItemsForUnit(unit);
            gameState.inventory.push(...newItems);

            // Remove unit from available list? Or mark as sold to player?
            // Original logic removed it from "availableUnits" implicitly by regenerating or just showing the reveal screen.
            // But if we want to return to the list later, we should mark it.
            // However, the game flow is: Buy -> Reveal -> Hub. So we don't need to persist it in the list for this round usually.
            // But let's follow the standard 'revealItems' flow which replaces the screen.

            revealItems(newItems);
        }

        function renderStorageSelection() {
            const containerHtml = gameState.availableUnits.map(unit => {
                let riskClass;
                if(unit.risk === 3) riskClass = 'risk-black';
                else riskClass = unit.risk === 0 ? 'risk-low' : (unit.risk === 1 ? 'risk-med' : 'risk-high');

                const isSold = unit.soldTo !== null;
                // Min start bid is approx 50% of avg estimate, checking afford based on that
                const startBid = Math.floor((unit.estimatedMin + unit.estimatedMax) / 2 * 0.5);
                const canAfford = gameState.money >= startBid;

                let cardContent = `
                    <h3>${unit.name}</h3>
                    <p>${unit.description}</p>
                    <div class="risk-badge ${riskClass}">Risk: ${unit.riskLabel}</div>
                    <div class="unit-price" style="margin-top:auto; font-size:1.1rem; color:#ccc;">
                        Tahmini: <span style="color:var(--accent-color); font-weight:bold;">${unit.estimatedMin} - ${unit.estimatedMax} ‚Ç∫</span>
                    </div>
                `;

                let clickAction = "";
                let cardStyle = "";

                if (isSold) {
                    cardContent += `<div style="margin-top:10px; color:var(--danger-color); font-weight:bold; border:2px solid var(--danger-color); padding:5px; border-radius:5px; transform:rotate(-5deg);">SATILDI: ${unit.soldTo.name}</div>`;
                    cardStyle = "opacity:0.6; filter:grayscale(0.8); cursor:default;";
                } else {
                    if (canAfford) {
                        clickAction = `onclick="startAuction(${unit.id})"`;
                    } else {
                        cardStyle = "opacity:0.5; cursor:not-allowed;";
                    }
                }

                return `
                <div class="storage-card ${unit.className}" ${clickAction} style="${cardStyle}">
                    ${cardContent}
                </div>
                `;
            }).join('');

            ui.app.innerHTML = `
                <div class="screen">
                    <h2 style="font-size:2rem; margin-bottom:10px">üì¢ G√úN√úN ƒ∞HALESƒ∞</h2>
                    <p style="color:#aaa">Mevcut Bakiye: <span class="money">${gameState.money} ‚Ç∫</span></p>
                    <div class="storage-grid">
                        ${containerHtml}
                    </div>
                    <button class="btn" onclick="startHubPhase()">üèôÔ∏è ≈ûEHRE D√ñN</button>
                </div>
            `;
        }

        // --- EXPERT PHASE ---

        window.startExpertPhase = function() {
            renderExpert();
        };

        function renderExpert() {
             const listHtml = gameState.inventory.map(item => {
                let rarityInfo = Object.values(RARITY).find(r => r.id === item.type);
                const fee = Math.max(50, Math.floor(item.realValue * 0.05));
                const canAfford = gameState.money >= fee;

                return `
                <div class="item-row rarity-${item.type}">
                    <div>
                        <strong>${item.name}</strong> ${item.certified ? '‚úÖ' : ''}<br>
                        <span style="color:${rarityInfo.color}; font-size:0.8rem">${rarityInfo.label}</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        ${item.certified
                            ? `<span style="color:var(--success-color); font-weight:bold;">DEƒûER: ${item.realValue} ‚Ç∫</span>`
                            : `<button class="btn" style="font-size:0.8rem" onclick="certifyItem(${item.id}, ${fee})" ${!canAfford ? 'disabled' : ''}>ONAYLAT (-${fee}‚Ç∫)</button>`
                        }
                    </div>
                </div>
                `;
            }).join('');

            ui.app.innerHTML = `
                <div class="screen screen-glass">
                    <h2>üßê EKSPERTƒ∞Z B√úROSU</h2>
                    <p>Burada ≈ü√ºpheli e≈üyalarƒ±n orijinalliƒüini kanƒ±tlayabilirsin. Onaylƒ± e≈üyalar EO kar≈üƒ±sƒ±nda daha deƒüerli olur.</p>
                    <p>Paran: <span class="money">${gameState.money} ‚Ç∫</span></p>
                    <div class="item-list">
                        ${listHtml}
                    </div>
                    <button class="btn" onclick="startHubPhase()">üèôÔ∏è ≈ûEHRE D√ñN</button>
                </div>
            `;
        }

        window.certifyItem = function(id, fee) {
            if (gameState.money < fee) return;

            const item = gameState.inventory.find(i => i.id === id);
            gameState.money -= fee;

            // 25% Chance for Fake/Junk
            if (Math.random() < 0.25) {
                item.type = 'junk';
                item.name = item.name + " (SAHTE)";
                item.realValue = Math.floor(item.realValue * 0.01); // 1% value
                alert("EKSPERT RAPORU: Bu √ºr√ºn SAHTE √ßƒ±ktƒ±! Deƒüeri d√º≈üt√º.");
            }

            item.certified = true;

            updateHeader();
            renderExpert();
        };

        // --- SHOP & NEGOTIATION ---

        let negotiationState = null;
        let selectedForBulk = new Set();

        window.startShopPhase = function() {
            selectedForBulk.clear();
            renderShop();
        };

        function toggleBulkSelection(id) {
            if (selectedForBulk.has(id)) selectedForBulk.delete(id);
            else selectedForBulk.add(id);
            renderShop(); // Re-render to update buttons state if needed
        }

        window.sellBulk = function() {
            if (selectedForBulk.size === 0) return;

            let totalValue = 0;
            const itemsToSell = [];

            gameState.inventory.forEach(item => {
                if(selectedForBulk.has(item.id)) {
                    // Bulk price is 60% of base estimate (approx realValue * 0.6)
                    totalValue += Math.floor(item.realValue * 0.6);
                    itemsToSell.push(item.id);
                }
            });

            if (confirm(`${itemsToSell.length} adet e≈üyayƒ± toplam ${totalValue} ‚Ç∫ kar≈üƒ±lƒ±ƒüƒ±nda satmak istiyor musun?`)) {
                gameState.money += totalValue;
                gameState.inventory = gameState.inventory.filter(i => !selectedForBulk.has(i.id));
                selectedForBulk.clear();
                updateHeader();
                renderShop();
            }
        };

        function renderShop() {
            // If inventory empty, suggest leaving
            if (gameState.inventory.length === 0) {
                ui.app.innerHTML = `
                    <div class="screen screen-glass">
                        <h2>üè™ D√úKKAN BO≈û</h2>
                        <p>Satacak bir ≈üeyin kalmadƒ±.</p>
                        <button class="btn" onclick="startHubPhase()">üèôÔ∏è ≈ûEHRE D√ñN</button>
                    </div>
                `;
                return;
            }

            if (negotiationState) {
                renderNegotiation();
                return;
            }

            const listHtml = gameState.inventory.map(item => {
                let rarityInfo = Object.values(RARITY).find(r => r.id === item.type);
                const isSelected = selectedForBulk.has(item.id);

                return `
                <div class="item-row rarity-${item.type}">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <input type="checkbox" onchange="toggleBulkSelection(${item.id})" ${isSelected ? 'checked' : ''}>
                        <div>
                            <strong>${item.name}</strong> ${item.certified ? '<span class="certified-badge">ONAYLI</span>' : ''}<br>
                            <span style="color:${rarityInfo.color}; font-size:0.8rem">${rarityInfo.label}</span>
                        </div>
                    </div>
                    <button class="btn" style="font-size:0.8rem" onclick="initNegotiation(${item.id})">SAT üí∞</button>
                </div>
                `;
            }).join('');

            const bulkCount = selectedForBulk.size;

            ui.app.innerHTML = `
                <div class="screen screen-glass">
                    <h2>üè™ EO'NUN D√úKKANI</h2>
                    <p>EO: "${EO_AI.getLine('greeting', gameState.reputation)}"</p>
                    <div style="text-align:right; margin-bottom:10px;">
                        <button class="btn btn-purple" onclick="sellBulk()" ${bulkCount === 0 ? 'disabled' : ''}>
                            üóëÔ∏è SE√áƒ∞LENLERƒ∞ TOPLU SAT (%60)
                        </button>
                    </div>
                    <div class="item-list">
                        ${listHtml}
                    </div>
                    <button class="btn" onclick="startHubPhase()">üèôÔ∏è ≈ûEHRE D√ñN</button>
                </div>
            `;
        }

        window.initNegotiation = function(itemId) {
            const item = gameState.inventory.find(i => i.id === itemId);

            // Check Memory and handle "Return with Certificate" logic
            let mem = gameState.negotiationMemory[itemId];

            // Special case: Player certified the item AFTER a failed negotiation
            // Logic: Memory exists, was NOT certified in memory, but IS certified now
            if (mem && !mem.wasCertified && item.certified) {
                 // Reset memory for this item effectively to allow re-pricing
                 delete gameState.negotiationMemory[itemId];
                 mem = null;
            }

            if (mem) {
                negotiationState = {
                    item: item,
                    currentOffer: mem.offer,
                    status: 'active',
                    dialogue: mem.dialogue || "Kaldƒ±ƒüƒ±mƒ±z yerden devam edelim."
                };
            } else {
                // Determine dialogue tone based on reputation
                let repTier = 'neutral';
                if (gameState.reputation > 70) repTier = 'friendly';
                else if (gameState.reputation < 30) repTier = 'suspicious';

                // --- EXPERT CONSULTATION TRIGGER ---
                let isConsulting = false;
                let consultChance = 0.3; // Default Neutral
                if (repTier === 'friendly') consultChance = 0.1;
                else if (repTier === 'suspicious') consultChance = 0.6;

                if (Math.random() < consultChance) {
                    isConsulting = true;
                }
                // -----------------------------------

                let initialOffer = EO_AI.calculateOffer(item.realValue, gameState.reputation);
                let startDialogue = EO_AI.getLine('inspecting', gameState.reputation);

                // Logic for rare/uncertified items
                if ((item.type === 'rare' || item.type === 'legendary') && !item.certified) {
                    // Suspicion Check logic
                    let suspicionChance = 0.8; // Base 80%
                    if (gameState.reputation > 70) suspicionChance = 0.2; // 20% for Friends
                    if (gameState.reputation > 90) suspicionChance = 0.05; // 5% for Partners

                    if (Math.random() < suspicionChance) {
                        // SUSPICIOUS: Lowball hard
                        initialOffer = Math.floor(initialOffer * 0.3);
                        if(repTier === 'friendly') {
                            startDialogue = "Dostum bu √ßok deƒüerli g√∂r√ºn√ºyor ama sahteleri √ßok. Bir belgen var mƒ±?";
                        } else if (repTier === 'suspicious') {
                             startDialogue = "Bunu √ßaldƒ±n mƒ±? Belgesiz hi√ßbir ≈üey almam, ya da hurda parasƒ±na alƒ±rƒ±m.";
                        } else {
                            startDialogue = "Bu ne? Sahte gibi duruyor. Kanƒ±tƒ±n var mƒ±? Yoksa sana ancak √ß√∂p parasƒ± veririm.";
                        }
                    } else {
                        // TRUSTED: Treat as if certified (better offer, normal dialogue)
                        // Slightly reduce offer compared to certified but much better than lowball
                        initialOffer = Math.floor(item.realValue * (0.6 + Math.random() * 0.2));

                        if(repTier === 'friendly') {
                            startDialogue = "G√ºzel par√ßa! Senden geldiƒüi i√ßin orijinalliƒüine g√ºveniyorum.";
                        } else {
                            startDialogue = "Riskli bir par√ßa ama sana g√ºveneceƒüim. Fiyatƒ±m bu.";
                        }
                    }
                } else if (item.certified) {
                     initialOffer = Math.floor(initialOffer * 1.5); // Better offer

                     // Check if this is a "Return with Certificate" moment
                     // We know it is because we cleared 'mem' above if it was a return.
                     // But we want specific dialogue if it's a return.
                     // A simple heuristic: If the offer is much higher than what it would be uncertified.
                     // Better: Just check if we had memory before we cleared it? No, too late.
                     // Let's rely on standard certified lines, OR add a flag.

                     if (gameState.negotiationMemory[itemId] === undefined) {
                         // It could be a fresh item OR a cleared memory item.
                         // We can't easily distinguish without more state.
                         // But we can say "Belgeletmi≈üsin" generally if it is certified.

                         if(repTier === 'friendly') {
                             startDialogue = "Belgeletmi≈üsin! ƒ∞≈üte ≈üimdi ciddile≈üebiliriz dostum.";
                         } else {
                             startDialogue = "Belgeletmi≈üsin, ≈üimdi ciddile≈üebiliriz.";
                         }
                     }
                }

                // If consulting, override dialogue
                if (isConsulting) {
                     const lines = EO_AI.dialogue.consulting_start[repTier];
                     const rawLine = lines[Math.floor(Math.random() * lines.length)];
                     startDialogue = rawLine.replace("${itemName}", item.name);
                }

                negotiationState = {
                    item: item,
                    currentOffer: initialOffer,
                    status: 'active', // active, sold, failed
                    lastMove: 'start',
                    dialogue: startDialogue,
                    isConsulting: isConsulting
                };

                // Save immediately
                saveNegotiationState();

                // Handle the timer if consulting
                if (isConsulting) {
                    setTimeout(() => {
                         // Check if we are still negotiating the same item
                         if(negotiationState && negotiationState.item.id === item.id && negotiationState.isConsulting) {
                             negotiationState.isConsulting = false;
                             negotiationState.dialogue = EO_AI.getLine('consulting_end', gameState.reputation);
                             
                             // Update memory to reflect we returned
                             saveNegotiationState();
                             renderNegotiation();
                         }
                    }, 5000);
                }
            }

            renderNegotiation();
        };

        function saveNegotiationState() {
            if (negotiationState && negotiationState.item) {
                gameState.negotiationMemory[negotiationState.item.id] = {
                    offer: negotiationState.currentOffer,
                    dialogue: negotiationState.dialogue,
                    wasCertified: negotiationState.item.certified // Store this to detect changes later
                };
            }
        }

        function renderNegotiation() {
            const state = negotiationState;
            const item = state.item;
            const rarityInfo = Object.values(RARITY).find(r => r.id === item.type);
            const playerKnowsValue = item.certified;

            // Check consulting state
            const isConsulting = state.isConsulting;

            // Patience Visualization
            let patienceHtml = '';
            for(let i=0; i<4; i++) {
                patienceHtml += (i < gameState.eoPatience) ? 'üî¥ ' : '‚ö™ ';
            }

            const patienceLow = gameState.eoPatience <= 0;

            ui.app.innerHTML = `
                <div class="screen screen-glass" style="max-width:1000px; padding:0;">
                    <div class="scene-container">
                        <div class="scene-overlay"></div>
                        <div class="eo-avatar-container">
                             ${isConsulting 
                                ? `<div style="height:120px; display:flex; align-items:center; justify-content:center; color:#ccc; font-style:italic; font-size:1.2rem; text-shadow:0 0 10px rgba(0,0,0,0.8);">(Uzman aranƒ±yor...)</div>` 
                                : `<div class="eo-avatar">üë∫</div>`
                             }
                             <div class="speech-bubble">"${state.dialogue}"</div>
                             <div style="margin-top:10px; font-size:1.2rem; background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:10px;">
                                SABIR: ${patienceHtml}
                             </div>
                        </div>

                        <div class="negotiation-desk">
                            <div class="desk-item">
                                <h3 style="margin:0; color:var(--accent-color)">${item.name}</h3>
                                <div style="font-size:0.8rem; opacity:0.8">${rarityInfo.label} ${item.certified ? '‚úÖ' : ''}</div>
                                <div style="margin-top:5px; font-weight:bold; color:var(--success-color)">TEKLƒ∞F: ${state.currentOffer} ‚Ç∫</div>
                                ${playerKnowsValue ? `<div style="font-size:0.7rem; color:#aaa">Ger√ßek Deƒüer: ${item.realValue} ‚Ç∫</div>` : ''}
                            </div>

                            <div class="desk-actions">
                                <button class="btn" onclick="actionAccept()" ${isConsulting ? 'disabled' : ''}>‚úÖ KABUL (${state.currentOffer} ‚Ç∫)</button>
                                <button class="btn" onclick="showCounterInput()" ${patienceLow || isConsulting ? 'disabled' : ''}>üí¨ PAZARLIK</button>
                                <button class="btn btn-purple" onclick="actionBluff()" ${patienceLow || isConsulting ? 'disabled' : ''}>üé≤ BL√ñF</button>
                                <button class="btn btn-danger" onclick="actionThreaten()" ${patienceLow || isConsulting ? 'disabled' : ''}>ü§¨ TEHDƒ∞T</button>
                                <button class="btn" style="background:transparent; border:1px solid #555;" onclick="actionCancel()" ${isConsulting ? 'disabled' : ''}>‚ùå VAZGE√á</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        window.actionAccept = function() {
            // Sell item
            gameState.money += negotiationState.currentOffer;

            // Remove item
            gameState.inventory = gameState.inventory.filter(i => i.id !== negotiationState.item.id);
            // Clear from memory as it's sold
            if (gameState.negotiationMemory[negotiationState.item.id]) {
                delete gameState.negotiationMemory[negotiationState.item.id];
            }

            // Reputation small boost for easy deal
            changeReputation(1);

            negotiationState = null;
            updateHeader();
            renderShop();
        };

        window.actionCancel = function() {
            saveNegotiationState();
            negotiationState = null;
            renderShop();
        };

        window.showCounterInput = function() {
            const currentOffer = negotiationState.currentOffer;
            const promptAmount = prompt("Kar≈üƒ± teklifin nedir? (Sadece sayƒ±)", currentOffer);
            if (promptAmount) {
                const val = parseInt(promptAmount);
                if (!isNaN(val)) {
                    processCounterOffer(val);
                }
            }
        };

        function processCounterOffer(playerOffer) {
            const state = negotiationState;
            const item = state.item;
            const realValue = item.realValue;

            // Logic: Is the offer reasonable?
            let repBonus = (gameState.reputation - 50) / 100; // -0.5 to 0.5
            let maxTolerable = realValue * (1.0 + repBonus);

            // Certification Logic: If rare/legendary and NOT certified, he won't pay near full value
            // unless forced or convinced.
            if ((item.type === 'rare' || item.type === 'legendary') && !item.certified) {
                // If Friendly, he is slightly more lenient
                if (gameState.reputation > 70) maxTolerable = realValue * 0.65;
                else maxTolerable = realValue * 0.5;
            }

            // Hidden Interest Mechanic
            if (item.eoInterest === 2) {
                // He really wants it, so he will tolerate higher prices eventually
                maxTolerable *= 1.5;
            } else if (item.eoInterest === 1) {
                maxTolerable *= 1.2;
            }

            if (playerOffer <= state.currentOffer) {
                state.dialogue = "Daha d√º≈ü√ºk teklif mi? Kafan mƒ± g√ºzel? Neyse, kabul.";
                state.currentOffer = playerOffer;
                renderNegotiation();
                return;
            }

            if (playerOffer <= maxTolerable) {
                // Success chance based on how greedy the player is
                const greedFactor = playerOffer / realValue; // 1.0 = fair, 1.2 = pushing it
                // Friend bonus: easier to convince
                let successChanceModifier = (gameState.reputation - 50) / 200; // +/- 0.25

                const roll = Math.random();

                if (roll > (greedFactor - 0.5 - successChanceModifier)) {
                    // Accepted
                    state.currentOffer = playerOffer;

                    if (item.eoInterest === 2) {
                         state.dialogue = "Tamam tamam, alƒ±yorum. Sakƒ±n kimseye bu fiyattan bahsetme.";
                    } else {
                         state.dialogue = EO_AI.getLine('accept', gameState.reputation);
                    }
                } else {
                    // Counter-counter
                    const middleGround = Math.floor((state.currentOffer + playerOffer) / 2);
                    state.currentOffer = middleGround;
                    state.dialogue = EO_AI.getLine('lowball', gameState.reputation);
                    gameState.eoPatience -= 1;
                }
            } else {
                // Insultingly high
                state.dialogue = EO_AI.getLine('reject', gameState.reputation);
                gameState.eoPatience -= 1;
            }

            saveNegotiationState();
            checkPatience();
            renderNegotiation();
        }

        window.actionBluff = function() {
            const state = negotiationState;
            // Bluff mechanics: Try to increase perceived value
            const roll = Math.random();
            const successChance = 0.4 + (gameState.reputation / 200);

            if (roll < successChance) {
                // Success
                state.currentOffer = Math.floor(state.currentOffer * 1.5);
                state.dialogue = "Hmm... Ger√ßekten mi? Bak bunu fark etmemi≈ütim. Fiyatƒ± arttƒ±rƒ±yorum.";
            } else {
                // Fail
                state.dialogue = "Kimi kandƒ±rƒ±yorsun sen? Bu numara bana s√∂kmez.";
                gameState.eoPatience -= 2;
                changeReputation(-5);
            }
            saveNegotiationState();
            checkPatience();
            renderNegotiation();
        };

        window.actionThreaten = function() {
            const state = negotiationState;
            // High risk
            const roll = Math.random();
            if (roll > 0.7) {
                // Success: Force max value
                state.currentOffer = Math.floor(state.item.realValue * 1.2);
                state.dialogue = EO_AI.getLine('threatResponse');
                changeReputation(-10); // Reputation hit even if successful
            } else {
                // Fail: EO ends negotiation
                state.dialogue = "Defol d√ºkkanƒ±mdan!";
                gameState.eoPatience = 0;
            }
            saveNegotiationState();
            checkPatience();
            renderNegotiation();
        };

        function checkPatience() {
            if (gameState.eoPatience <= 0) {
                // Force sell at low price or kick out?
                // For now, let's say he forces the last offer or kicks out.
                // Let's make him withdraw the offer and offer a pity amount (scrap value).
                negotiationState.dialogue = "Sabrƒ±mƒ± ta≈üƒ±rdƒ±n. Ya bu fiyata alƒ±rsƒ±n ya da defolursun.";
                // Don't nuke the offer completely to 0, just leave it as last offer, but he refuses to negotiate more.
                // Reverting logic: "e≈üyalara verdiƒüi son teklifi ... sƒ±fƒ±rlanmasƒ±n"
                // But if he gets angry, does he lower it?
                // The prompt says: "e≈üyalara verdiƒüi son teklifi ve sabrƒ± vazge√ß tu≈üuna tƒ±klayƒ±nca sƒ±fƒ±rlanmasƒ±n"
                // It doesn't explicitly say we can't lower it on failed negotiations.
                // But usually "Sabrƒ±mƒ± ta≈üƒ±rdƒ±n" means take it or leave it.
                // I will keep the current offer but prevent further actions (handled in renderNegotiation via disabled buttons).
            }
        }

        // --- HELPERS ---
        function changeReputation(amount) {
            gameState.reputation = Math.min(100, Math.max(0, gameState.reputation + amount));
        }

        function finishRound() {
            gameState.round++;
            gameState.availableUnits = [];
            ui.app.innerHTML = `
                <div class="screen">
                    <h2>TUR TAMAMLANDI</h2>
                    <p>Bug√ºnk√º hasƒ±latƒ± topladƒ±n.</p>
                    <p class="money" style="font-size:2rem">${gameState.money} ‚Ç∫</p>
                    <button class="btn" onclick="startRound()">SONRAKƒ∞ TUR</button>
                </div>
            `;
            updateHeader();
        }

        window.buyUnit = function(id) {
            const unit = gameState.availableUnits.find(u => u.id === id);
            if(gameState.money < unit.price) return;

            gameState.money -= unit.price;
            gameState.currentUnit = unit;
            updateHeader();

            // Generate items
            const newItems = generateItemsForUnit(unit);
            gameState.inventory.push(...newItems);

            revealItems(newItems);
        };

        function generateItemsForUnit(unit) {
            const itemCount = 3 + Math.floor(Math.random() * 3); // 3-5 items
            const items = [];

            for(let i=0; i<itemCount; i++) {
                // Determine rarity based on risk
                let roll = Math.random();
                let chosenType = 'junk';

                if (unit.risk === 3) { // Black Market: High Risk / High Reward
                    // 40% Junk, 30% Rare, 30% Legendary
                    if (roll < 0.40) chosenType = 'junk';
                    else if (roll < 0.70) chosenType = 'rare';
                    else chosenType = 'legendary';
                } else if (unit.risk === 0) { // Low Risk: Mostly Common (0.4-0.95), some Junk (<0.4), rare Rare (>0.95)
                    if (roll < 0.40) chosenType = 'junk';
                    else if (roll < 0.95) chosenType = 'common';
                    else chosenType = 'rare'; // 5% Rare, 0% Legendary
                } else if (unit.risk === 1) { // Med Risk: Balanced
                    if (roll < 0.30) chosenType = 'junk';
                    else if (roll < 0.85) chosenType = 'common';
                    else if (roll < 0.985) chosenType = 'rare'; // 13.5% Rare
                    else chosenType = 'legendary'; // 1.5% Legendary (Very rare)
                } else { // High Risk: High Junk, but potential for Rare/Legendary
                    if (roll < 0.50) chosenType = 'junk'; // 50% Junk
                    else if (roll < 0.85) chosenType = 'common'; // 35% Common
                    else if (roll < 0.98) chosenType = 'rare'; // 13% Rare
                    else chosenType = 'legendary'; // 2% Legendary
                }

                const possibleItems = ITEMS_DB.filter(x => x.type === chosenType);
                const template = possibleItems[Math.floor(Math.random() * possibleItems.length)];

                // Variation in value
                const valueVariation = 0.8 + (Math.random() * 0.4); // +/- 20%
                const finalValue = Math.floor(template.baseValue * valueVariation);

                items.push({
                    ...template,
                    realValue: finalValue,
                    eoInterest: Math.random() > 0.8 ? 2 : (Math.random() > 0.5 ? 1 : 0), // 0=None, 1=Mild, 2=High
                    id: Date.now() + i
                });
            }
            return items;
        }

        function revealItems(newItems) {
            const listHtml = newItems.map(item => {
                let rarityInfo = Object.values(RARITY).find(r => r.id === item.type);
                return `
                <div class="item-row rarity-${item.type}">
                    <div>
                        <strong>${item.name}</strong><br>
                        <span style="color:${rarityInfo.color}; font-size:0.8rem">${rarityInfo.label}</span>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <span style="color:#888; font-size:0.9rem">Tahmini: ???</span>
                    </div>
                </div>
                `;
            }).join('');

            ui.app.innerHTML = `
                <div class="screen">
                    <h2>DEPODAN √áIKANLAR</h2>
                    <div class="item-list">
                        ${listHtml}
                    </div>
                    <button class="btn" onclick="startHubPhase()">üèôÔ∏è ≈ûEHƒ∞R MERKEZƒ∞NE Gƒ∞T</button>
                </div>
            `;
        }

        // --- WORKSHOP SYSTEM ---
        window.startWorkshopPhase = function() {
            renderWorkshop();
        };

        function renderWorkshop() {
            const junkItems = gameState.inventory.filter(i => i.type === 'junk');
            const repairCost = 200;
            const canAfford = gameState.money >= repairCost;

            // Restorer Skill Chance
            const skillLevel = gameState.skills.restorer || 0;
            const successChance = Math.min(0.9, 0.3 + (skillLevel * 0.15));

            const listHtml = junkItems.map(item => `
                <div class="item-row rarity-junk">
                    <div>
                        <strong>${item.name}</strong><br>
                        <span style="color:#9e9e9e; font-size:0.8rem">Hurda</span>
                    </div>
                    <button class="btn" onclick="repairItem(${item.id})" ${!canAfford ? 'disabled' : ''}>
                        üî® ONAR (${repairCost}‚Ç∫) %${Math.round(successChance * 100)}
                    </button>
                </div>
            `).join('');

            ui.app.innerHTML = `
                <div class="screen screen-glass">
                    <h2>üõ†Ô∏è AT√ñLYE</h2>
                    <p>Hurda e≈üyalarƒ± onarmayƒ± dene. Ba≈üarƒ±sƒ±z olursan e≈üya yok olur!</p>
                    <p>Paran: <span class="money">${gameState.money} ‚Ç∫</span></p>

                    ${junkItems.length === 0 ? '<p>Onarƒ±lacak hurda yok.</p>' : `<div class="item-list">${listHtml}</div>`}

                    <button class="btn" onclick="startHubPhase()">üèôÔ∏è ≈ûEHRE D√ñN</button>
                </div>
            `;
        }

        window.repairItem = function(itemId) {
            if (gameState.money < 200) return;
            gameState.money -= 200;

            const itemIndex = gameState.inventory.findIndex(i => i.id === itemId);
            if (itemIndex === -1) return;
            const item = gameState.inventory[itemIndex];

            // Success Check
            const skillLevel = gameState.skills.restorer || 0;
            const successChance = Math.min(0.9, 0.3 + (skillLevel * 0.15));

            if (Math.random() < successChance) {
                // Success! Convert to Common or Rare
                const isRare = Math.random() < 0.3; // 30% chance for Rare upgrade
                const newType = isRare ? 'rare' : 'common';

                // Update Item
                item.type = newType;
                item.name = item.name.replace(' (Hurda)', '').replace('Kƒ±rƒ±k ', 'Onarƒ±lmƒ±≈ü ').replace('Bozuk ', 'Tamir Edilmi≈ü ');
                if (!item.name.includes('Onarƒ±lmƒ±≈ü') && !item.name.includes('Tamir Edilmi≈ü')) {
                    item.name = "Onarƒ±lmƒ±≈ü " + item.name;
                }

                // Update Value
                const baseVal = isRare ? 5000 : 500;
                item.realValue = Math.floor(baseVal * (0.8 + Math.random() * 0.4));
                item.certified = false; // Reset certification

                alert(`üéâ BA≈ûARILI! E≈üya onarƒ±ldƒ±: ${item.name}`);
            } else {
                // Fail - Destroy
                gameState.inventory.splice(itemIndex, 1);
                alert("üí• BA≈ûARISIZ! E≈üya par√ßalarƒ±na ayrƒ±ldƒ± ve yok oldu.");
            }
            updateHeader();
            renderWorkshop();
        };

        // --- SKILL SYSTEM ---
        window.startSkillsPhase = function() {
            renderSkills();
        };

        function renderSkills() {
            const skillHtml = Object.values(SKILLS_CONFIG).map(skill => {
                const currentLvl = gameState.skills[skill.id] || 0;
                const canUpgrade = currentLvl < skill.maxLevel && gameState.skillPoints >= skill.cost;

                return `
                <div class="item-row" style="background:rgba(255,255,255,0.05); flex-direction:column; align-items:flex-start; gap:10px;">
                    <div style="width:100%; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <strong style="font-size:1.1rem; color:var(--accent-color)">${skill.name}</strong>
                            <span style="font-size:0.8rem; margin-left:10px; background:#333; padding:2px 6px; border-radius:4px;">Lvl ${currentLvl}/${skill.maxLevel}</span>
                        </div>
                        <button class="btn btn-purple" onclick="purchaseSkill('${skill.id}')" ${!canUpgrade ? 'disabled' : ''}>
                            ${currentLvl >= skill.maxLevel ? 'MAX' : `Y√úKSELT (${skill.cost} Puan)`}
                        </button>
                    </div>
                    <p style="margin:0; opacity:0.8; font-size:0.9rem">${skill.desc}</p>
                </div>
                `;
            }).join('');

            ui.app.innerHTML = `
                <div class="screen screen-glass">
                    <h2>üß† YETENEKLER</h2>
                    <p>Seviye atlayarak yetenek puanƒ± kazan.</p>
                    <p>Mevcut Puan: <span style="color:var(--accent-color); font-weight:bold; font-size:1.5rem;">${gameState.skillPoints}</span></p>

                    <div class="item-list">
                        ${skillHtml}
                    </div>

                    <button class="btn" onclick="startHubPhase()">üèôÔ∏è ≈ûEHRE D√ñN</button>
                </div>
            `;
        }

        window.purchaseSkill = function(skillId) {
            const skill = SKILLS_CONFIG[skillId];
            if (!skill) return;
            const currentLvl = gameState.skills[skillId] || 0;

            if (currentLvl < skill.maxLevel && gameState.skillPoints >= skill.cost) {
                gameState.skillPoints -= skill.cost;
                gameState.skills[skillId]++;

                // Immediate Effects
                if (skillId === 'hoarder') {
                    gameState.inventoryLimit += 5;
                    alert("Depo kapasitesi artƒ±rƒ±ldƒ±!");
                }

                renderSkills();
            }
        };

        // --- WAREHOUSE SYSTEM ---
        window.startWarehousePhase = function() {
            renderWarehouse();
        };

        function renderWarehouse() {
            const upgradeCost = 5000 * gameState.storageLevel;
            const canAfford = gameState.money >= upgradeCost;

            const listHtml = gameState.inventory.map(item => {
                let rarityInfo = Object.values(RARITY).find(r => r.id === item.type);
                return `
                <div class="item-row rarity-${item.type}" style="padding:10px;">
                    <div style="font-size:0.9rem">
                        <strong>${item.name}</strong> (${rarityInfo.label})
                    </div>
                    <div style="font-size:0.8rem; color:#aaa;">
                        ${item.certified ? `Deƒüer: ${item.realValue} ‚Ç∫` : 'Deƒüer: ???'}
                    </div>
                </div>
                `;
            }).join('');

            ui.app.innerHTML = `
                <div class="screen screen-glass">
                    <h2>üì¶ DEPO Y√ñNETƒ∞Mƒ∞</h2>
                    <div style="display:flex; justify-content:space-around; margin:20px 0;">
                        <div>
                            <div class="stat-label">KAPASƒ∞TE</div>
                            <div style="font-size:1.5rem">${gameState.inventory.length} / ${gameState.inventoryLimit}</div>
                        </div>
                        <div>
                            <div class="stat-label">G√úNL√úK Kƒ∞RA</div>
                            <div style="font-size:1.5rem; color:var(--danger-color)">${gameState.inventory.length * 50} ‚Ç∫</div>
                        </div>
                    </div>

                    <button class="btn btn-purple" onclick="upgradeStorage()" ${!canAfford ? 'disabled' : ''}>
                        ‚¨ÜÔ∏è DEPOYU B√úY√úT (+5 Yer) - ${upgradeCost} ‚Ç∫
                    </button>

                    <h3 style="margin-top:30px; text-align:left;">Envanter</h3>
                    <div class="item-list" style="max-height:300px; overflow-y:auto;">
                        ${listHtml}
                    </div>

                    <button class="btn" onclick="startHubPhase()">üèôÔ∏è ≈ûEHRE D√ñN</button>
                </div>
            `;
        }

        window.upgradeStorage = function() {
            const upgradeCost = 5000 * gameState.storageLevel;
            if (gameState.money >= upgradeCost) {
                gameState.money -= upgradeCost;
                gameState.inventoryLimit += 5;
                gameState.storageLevel++;
                alert("Depo b√ºy√ºt√ºld√º! Yeni kapasite: " + gameState.inventoryLimit);
                updateHeader();
                renderWarehouse();
            }
        };

        window.startHubPhase = function() {
            renderHub();
        };

        function renderHub() {
             // Quest Display
             const questsHtml = gameState.quests.map(q =>
                 `<div style="font-size:0.85rem; background:rgba(255,255,255,0.05); padding:8px; border-radius:5px; margin-bottom:5px; text-align:left; border-left:3px solid ${q.completed ? 'var(--success-color)' : 'var(--accent-color)'}">
                    ${q.completed ? '‚úÖ' : 'üìú'} ${q.text} (${q.current}/${q.count})
                 </div>`
             ).join('');

             ui.app.innerHTML = `
                <div class="screen">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h2>üèôÔ∏è ≈ûEHƒ∞R MERKEZƒ∞</h2>
                        <div style="text-align:right;">
                            <span style="font-size:0.9rem; color:var(--accent-color)">Seviye ${gameState.level}</span><br>
                            <span style="font-size:0.8rem; opacity:0.7">${gameState.xp}/${gameState.level * 1000} XP</span>
                        </div>
                    </div>

                    ${gameState.quests.length > 0 ? `
                        <div style="margin-bottom:20px;">
                            <h4 style="margin:5px 0; text-align:left; opacity:0.8;">G√úNL√úK G√ñREVLER</h4>
                            ${questsHtml}
                        </div>
                    ` : ''}

                    <div class="hub-menu">
                        <div class="hub-card" onclick="renderStorageSelection()">
                            <div class="hub-icon">üì¢</div>
                            <div class="hub-title">ƒ∞hale Alanƒ±</div>
                            <div>Kalan depolarƒ± incele ve satƒ±n al.</div>
                        </div>

                        <div class="hub-card" onclick="startShopPhase()">
                            <div class="hub-icon">üè™</div>
                            <div class="hub-title">EO'nun D√ºkkanƒ±</div>
                            <div>E≈üyalarƒ± sat ve pazarlƒ±k yap.</div>
                        </div>

                        <div class="hub-card" onclick="startExpertPhase()">
                            <div class="hub-icon">üßê</div>
                            <div class="hub-title">Ekspertiz</div>
                            <div>E≈üyalarƒ± onaylat ve deƒüerini √∂ƒüren.</div>
                        </div>

                        <div class="hub-card" onclick="startWorkshopPhase()">
                            <div class="hub-icon">üõ†Ô∏è</div>
                            <div class="hub-title">At√∂lye</div>
                            <div>Hurda e≈üyalarƒ± onar.</div>
                        </div>

                        <div class="hub-card" onclick="startSkillsPhase()">
                            <div class="hub-icon">üß†</div>
                            <div class="hub-title">Yetenekler</div>
                            <div>Karakterini geli≈ütir.</div>
                        </div>

                        <div class="hub-card" onclick="startWarehousePhase()">
                            <div class="hub-icon">üì¶</div>
                            <div class="hub-title">Depo</div>
                            <div>Envanterini y√∂net.</div>
                        </div>

                        <div class="hub-card" onclick="finishRound()" style="border-color:var(--success-color)">
                            <div class="hub-icon">üí§</div>
                            <div class="hub-title">G√ºn√º Bitir</div>
                            <div>Sonraki tura ge√ß.</div>
                        </div>
                    </div>
                </div>
            `;
        }

    </script>
</body>
</html>
